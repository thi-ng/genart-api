"use strict";(()=>{var ne=Object.defineProperty;var v=(a,t)=>{for(var e in t)ne(a,e,{get:t[e],enumerable:!0})};var A={};v(A,{clamp:()=>me,clamp01:()=>W,div:()=>b,easeInOut5:()=>$,fit:()=>z,mix:()=>oe,norm:()=>X,parseNum:()=>ie,round:()=>pe,smoothstep:()=>de,smoothstep01:()=>w});var ie=(a,t=0)=>{let e=a?parseFloat(a):Number.NaN;return isNaN(e)?t:e},oe=(a,t,e)=>a+(t-a)*e,z=(a,t,e,r,s)=>r+(s-r)*X(a,t,e),me=(a,t,e)=>a<t?t:a>e?e:a,W=a=>a<0?0:a>1?1:a,pe=(a,t)=>Math.round(b(a,t))*t,X=(a,t,e)=>b(a-t,e-t),b=(a,t)=>t!=0?a/t:0,de=(a,t,e)=>w(W(b(e-a,t-a))),w=a=>a*a*(3-2*a),ce=a=>{let t=2**(a-1);return e=>e<.5?t*e**a:1-(-2*e+2)**a/2},$=ce(5);var V={};v(V,{choice:()=>E,color:()=>le,date:()=>fe,datetime:()=>ue,image:()=>Pe,numlist:()=>F,ramp:()=>he,range:()=>ge,strlist:()=>ye,text:()=>_e,time:()=>Te,toggle:()=>xe,weighted:()=>be,xy:()=>we});var l=(a,t,e=!0)=>({type:a,state:"void",randomize:e,...t}),E=a=>l("choice",a),le=a=>l("color",a),ue=a=>l("datetime",a,!1),fe=a=>l("date",a,!1),Pe=a=>l("img",{default:a.default||new Uint8Array(a.width*a.height),...a},!1),F=a=>l("numlist",{default:[],...a},!1),he=a=>l("ramp",{name:a.name,desc:a.desc,doc:a.doc,stops:a.stops?a.stops.flat():[0,0,1,1],mode:a.mode||"linear",default:0},!1),ge=a=>l("range",{min:0,max:100,step:1,...a}),ye=a=>l("strlist",{default:[],...a},!1),_e=a=>l("text",a,!1),Te=a=>l("time",a),xe=a=>l("toggle",a),be=a=>l("weighted",{...a,options:a.options.sort((t,e)=>e[0]-t[0]),total:a.options.reduce((t,e)=>t+e[0],0)}),we=a=>l("xy",a);var H=({targetFPS:a=60,history:t=200,width:e=t,height:r=100,sma:s=a,style:n="position:fixed;z-index:9999;top:0;right:0;",bg:i="#222",text:m="#fff",fps:d=["#0f0","#ff0","#f00","#303"]}={})=>{let p,o,K=e/t,re=e>=120,O=performance.now(),I=0,x=0,C=0,P=a,g=[];return{start(){O=performance.now(),I=0,C=0,P=a,p||(p=document.createElement("canvas"),p.width=e,p.height=r,p.id="#FPS",p.setAttribute("style",n),document.body.appendChild(p),o=p.getContext("2d"),o.font="10px sans-serif",o.textBaseline="middle",o.strokeStyle=m,o.setLineDash([1,1]))},next(D){requestAnimationFrame(D)},now(){return[x,I]},tick(){let D=[x=performance.now()-O,++I];g.length===t&&g.shift();let se=x-C;C=x,g.push(1e3/se);let h=g.length;P=Math.max(a,P+(Math.max(...g)-P)*.05);let T=o.createLinearGradient(0,0,0,p.height);T.addColorStop(1-a/P,d[0]),T.addColorStop(1-(a-1)/P,d[1]),T.addColorStop(1-a/2/P,d[2]),T.addColorStop(1,d[3]),o.fillStyle=i,o.fillRect(0,0,e,r),o.fillStyle=T,o.beginPath(),o.moveTo(0,r);for(let c=0;c<h;c++)o.lineTo(c*K,(1-g[c]/P)*r);o.lineTo((h-1)*K,r),o.closePath(),o.fill(),o.fillStyle=m,o.beginPath();for(let c of[a,a/2]){let u=(1-c/P)*r;o.moveTo(0,u),re?(o.lineTo(e-22,u),o.fillText(String(c),e-20,u+1)):o.lineTo(e,u)}if(o.stroke(),h>=s){let c=0;for(let u=h-s;u<h;u++)c+=g[u];c/=s,o.fillText(`sma(${s}) ${c.toFixed(1)} fps`,4,r-20)}if(h>=t){let c=0;for(let u=0;u<h;u++)c+=g[u];c/=h,o.fillText(`sma(${h}) ${c.toFixed(1)} fps`,4,r-8)}return D}}};var Y=(a=250,t=60,e=0)=>{let r=e,s=1e3/t;return{start(){r=e},next(n){setTimeout(n,a)},now(){return[r*s,r]},tick(){return[++r*s,r]}}};var k=(a=0,t=0)=>{let e=performance.now(),r=t,s=a;return{start(){e=performance.now(),r=t},next(n){requestAnimationFrame(n)},now(){return[s,r]},tick(){return[s=a+performance.now()-e,++r]}}};var S={};v(S,{formatValuePrec:()=>Se,isNumber:()=>q,isNumericArray:()=>Me,isString:()=>Ae,isTypedArray:()=>Z,u16:()=>R,u24:()=>B,u32:()=>Re,u8:()=>M,valuePrec:()=>J});var q=a=>typeof a=="number"&&!isNaN(a),Ae=a=>typeof a=="string",Me=a=>Z(a)||Array.isArray(a)&&a.every(q),Z=a=>!!a&&(a instanceof Float32Array||a instanceof Float64Array||a instanceof Uint32Array||a instanceof Int32Array||a instanceof Uint8Array||a instanceof Int8Array||a instanceof Uint16Array||a instanceof Int16Array||a instanceof Uint8ClampedArray),M=a=>(a&=255,(a<16?"0":"")+a.toString(16)),R=a=>M(a>>>8)+M(a),B=a=>R(a>>>8)+M(a&255),Re=a=>R(a>>>16)+R(a),J=a=>{let t=a.toString(),e=t.indexOf(".");return e>0?t.length-e-1:0},Se=a=>{let t=J(a);return e=>e.toFixed(t)};var{isNumber:y,isString:f,isNumericArray:N}=S,{clamp:Q,clamp01:ee,mix:L,norm:te,round:ae,parseNum:Ne}=A,G=class{id=Math.floor(Math.random()*1e12).toString(36);_adapter;_time=k();_prng;_update;_state="init";_traits;_params;_paramTypes={choice:{validate:(t,e)=>!!t.options.find(r=>(Array.isArray(r)?r[0]:r)===e),randomize:(t,e)=>{let r=t.options,s=r[e()*r.length|0];return Array.isArray(s)?s[0]:s}},color:{validate:(t,e)=>f(e)&&/^#?[0-9a-f]{6}$/.test(e),coerce:(t,e)=>e[0]!=="#"?"#"+e:e,randomize:(t,e)=>"#"+B(e()*16777216|0)},date:{validate:(t,e)=>e instanceof Date||y(e)||f(e)&&/^\d{4}-\d{2}-\d{2}$/.test(e),coerce:(t,e)=>y(e)?new Date(e):f(e)?new Date(Date.parse(e)):e},datetime:{validate:(t,e)=>e instanceof Date||y(e)||f(e)&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[-+]\d{2}:\d{2})$/.test(e),coerce:(t,e)=>y(e)?new Date(e):f(e)?new Date(Date.parse(e)):e},img:{validate:(t,e)=>{let{width:r,height:s}=t;return N(e)&&e.length==r*s}},numlist:{validate:(t,e)=>N(e)},ramp:{validate:()=>!1,read:(t,e)=>{let{stops:r,mode:s}=t,n=r.length,i=n;for(;(i-=2)>=0&&!(e>=r[i]););n-=2;let m=r[i],d=r[i+1],p=r[i+2],o=r[i+3];return i<0?r[1]:i>=n?r[n+1]:{exp:()=>L(d,o,$(te(e,m,p))),linear:()=>z(e,m,p,d,o),smooth:()=>L(d,o,w(te(e,m,p)))}[s||"linear"]()},params:{stops:F({name:"Ramp stops",desc:"Control points",default:[]}),mode:E({name:"Ramp mode",desc:"Interpolation method",options:["linear","smooth","exp"]})}},range:{validate:(t,e)=>{let{min:r,max:s}=t;return y(e)&&e>=r&&e<=s},coerce:(t,e)=>{let r=t;return Q(ae(e??r.default,r.step||1),r.min,r.max)},randomize:(t,e)=>{let{min:r,max:s,step:n}=t;return Q(ae(L(r,s,e()),n||1),r,s)}},strlist:{validate:(t,e)=>Array.isArray(e)&&e.every(f)},text:{validate:(t,e)=>{if(!f(e))return!1;let{min:r,max:s,match:n}=t;return n&&!(f(n)?new RegExp(n):n).test(e)?!1:(!r||e.length>=r)&&(!s||e.length<=s)}},time:{validate:(t,e)=>N(e)||f(e)&&/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(e),coerce:(t,e)=>f(e)?e.split(":").map(Ne):e,randomize:(t,e)=>[e()*24|0,e()*60|0,e()*24|0]},toggle:{validate:(t,e)=>f(e)?/^(true|false|0|1)$/.test(e):y(e)||typeof e=="boolean",coerce:(t,e)=>e==="true"||e==="1"?!0:e==="false"||e==="0"?!1:!!e,randomize:(t,e)=>e()<.5},weighted:{validate:(t,e)=>!!t.options.find(r=>r[1]===e),randomize:(t,e)=>{let{options:r,total:s,default:n}=t,i=e()*s;for(let m=0,d=r.length;m<d;m++)if(s-=r[m][0],s<=i)return r[m][1];return n}},xy:{validate:(t,e)=>N(e)&&e.length==2,coerce:(t,e)=>[ee(e[0]),ee(e[1])],randomize:(t,e)=>[e(),e()]}};math=A;params=V;utils=S;time={debug:H,offline:Y,raf:k};constructor(){window.addEventListener("message",t=>{let e=t.data;if(!(!this.isRecipient(t)||e?.__self))switch(e.type){case"genart:start":this.start();break;case"genart:resume":this.start(!0);break;case"genart:stop":this.stop();break;case"genart:setparamvalue":this.setParamValue(e.paramID,e.value,e.key);break;case"genart:randomizeparam":this.randomizeParamValue(e.paramID,e.key)}})}get mode(){return this._adapter?.mode||"play"}get screen(){return this._adapter?.screen||{width:window.innerWidth,height:window.innerHeight,dpr:window.devicePixelRatio}}get random(){return this._prng?this._prng:this._prng=_(this._adapter,"missing platform adapter").prng}get state(){return this._state}get paramSpecs(){return this._params}get adapter(){return this._adapter}get timeProvider(){return this._time}registerParamType(t,e){U(t),this._paramTypes[t]&&console.warn("overriding impl for param type:",t),this._paramTypes[t]=e}paramType(t){return U(t),this._paramTypes[t]}async setParams(t){try{this._adapter?.augmentParams&&(t=this._adapter.augmentParams(t));for(let e in t){j(e);let r=t[e];if(r.default==null){let s=this.ensureParamImpl(r.type);if(s.randomize)r.default=s.randomize(r,this.random.rnd),r.state="random";else if(s.read)r.state="dynamic";else throw new Error(`missing default value for param: ${e}`)}else r.state="default"}return this._params=t,this._adapter&&(this._adapter.initParams&&await this._adapter.initParams(t),await this.updateParams()),this.notifySetParams(),(e,r,s)=>this.getParamValue(e,r,s)}catch(e){throw this.setState("error",e.message),e}}setTraits(t){this._traits=t,this.emit({type:"genart:settraits",traits:t})}async setAdapter(t){console.log("set adapter",t),this._adapter=t,this.notifyReady()}waitForAdapter(){return this.waitFor("_adapter")}setTimeProvider(t){this._time=t,this.notifyReady()}waitForTimeProvider(){return this.waitFor("_time")}setUpdate(t){this._update=t,this.notifyReady()}async updateParams(t="none"){if(this._adapter)for(let e in this._params){let r=this._params[e],s=await this._adapter.updateParam(e,r);if(!s)continue;let{value:n,update:i}=s;if(i)for(let m in i)this.setParamValue(e,i[m],m,"none");this.setParamValue(e,n,void 0,n!=null||i?t:"none")}}setParamValue(t,e,r,s="all"){let{spec:n,impl:i}=this.ensureParam(t);if(e!=null){let m=n;if(r){let{spec:d,impl:p}=this.ensureNestedParam(n,r);m=d,i=p}if(!i.validate(m,e)){this.paramError(t);return}n[r||"value"]=i.coerce?i.coerce(m,e):e,r||(n.state="custom")}this.emit({type:"genart:paramchange",__self:!0,param:this.asNestedParam(n),paramID:t,key:r},s)}randomizeParamValue(t,e,r=Math.random,s="all"){let{spec:n,impl:{randomize:i}}=this.ensureParam(t),m=i&&n.randomize!==!1;if(e){let{spec:d,impl:p}=this.ensureNestedParam(n,e),o=p.randomize&&d.randomize!==!1;o&&this.setParamValue(t,p.randomize(d,r),e,o||!m?s:"none")}m&&this.setParamValue(t,i(n,r),void 0,s)}getParamValue(t,e=0,r){let{spec:s,impl:{randomize:n,read:i}}=this.ensureParam(t);return r&&n?n(s,r):i?i(s,e):s.value??s.default}paramError(t){this.emit({type:"genart:paramerror",paramID:t})}on(t,e){window.addEventListener("message",r=>{this.isRecipient(r)&&r.data?.type===t&&e(r.data)})}emit(t,e="all"){if(e==="none")return;t.apiID=this.id;let r=e==="all";(r||e==="self")&&window.postMessage(t,"*"),(r&&parent!==window||e==="parent")&&parent.postMessage(t,"*")}start(t=!1){let e=this._state;if(e=="play")return;if(e!=="ready"&&e!=="stop")throw new Error(`can't start in state: ${e}`);this.setState("play");let r=!t,s={type:"genart:frame",__self:!0,apiID:this.id,time:0,frame:0},n=()=>{if(this._state!="play")return;let i=this._time[r?"now":"tick"]();this._update.call(null,...i)?this._time.next(n):this.stop(),s.time=i[0],s.frame=i[1],this.emit(s),r=!1};t||this._time.start(),n(),this.emit({type:`genart:${t?"resume":"start"}`,__self:!0})}stop(){this._state==="play"&&(this.setState("stop"),this.emit({type:"genart:stop",__self:!0}))}capture(t){this._adapter?.capture(t),this.emit({type:"genart:capture",__self:!0},"parent")}setState(t,e){this._state=t,this.emit({type:"genart:statechange",__self:!0,state:t,info:e})}ensureParam(t){j(t);let e=_(_(this._params,"no params defined")[t],`unknown param: ${t}`);return{spec:e,impl:this.ensureParamImpl(e.type)}}ensureParamImpl(t){return U(t),_(this._paramTypes[t],`unknown param type: ${t}`)}ensureNestedParam(t,e){let r=_(this.ensureParamImpl(t.type).params?.[e],`param type '${t.type}' has no nested: ${e}`);return{spec:r,impl:this.ensureParamImpl(r.type)}}waitFor(t){return this[t]?Promise.resolve():new Promise(e=>{let r=()=>{this[t]?e():setTimeout(r,0)};r()})}notifySetParams(){this._params&&Object.keys(this._params).length&&this.emit({type:"genart:setparams",__self:!0,params:this.asNestedParams({},this._params)})}notifyReady(){this._state==="init"&&this._adapter&&this._time&&this._update&&this.setState("ready")}isRecipient({data:t}){return t!=null&&typeof t=="object"&&t.apiID===this.id}asNestedParams(t,e){for(let r in e)t[r]=this.asNestedParam(e[r]);return t}asNestedParam(t){let e={...t},r=this._paramTypes[t.type];return r.params&&(e.__params=this.asNestedParams({},r.params)),e}},_=(a,t)=>{if(!a)throw new Error(t);return a},j=(a,t="ID")=>_(!(a==="__proto__"||a==="prototype"||a==="constructor"),`illegal param ${t}: ${a}`),U=a=>j(a,"type");globalThis.$genart=new G;})();
