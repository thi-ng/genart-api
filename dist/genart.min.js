"use strict";(()=>{var N=Object.defineProperty;var g=(a,t)=>{for(var e in t)N(a,e,{get:t[e],enumerable:!0})};var h={};g(h,{clamp:()=>$,clamp01:()=>A,div:()=>f,easeInOut5:()=>y,fit:()=>_,mix:()=>B,norm:()=>M,parseNum:()=>k,round:()=>V,smoothStep:()=>v,smoothStep01:()=>c});var k=(a,t=0)=>{let e=a?parseFloat(a):Number.NaN;return isNaN(e)?t:e},B=(a,t,e)=>a+(t-a)*e,_=(a,t,e,r,s)=>r+(s-r)*M(a,t,e),$=(a,t,e)=>a<t?t:a>e?e:a,A=a=>a<0?0:a>1?1:a,V=(a,t)=>Math.round(a/t)*t,M=(a,t,e)=>f(a-t,e-t),f=(a,t)=>t!=0?a/t:0,v=(a,t,e)=>c(A(f(e-a,t-a))),c=a=>a*a*(3-2*a),W=a=>{let t=2**(a-1);return e=>e<.5?t*e**a:1-(-2*e+2)**a/2},y=W(5);var w={};g(w,{choice:()=>j,color:()=>K,date:()=>U,datetime:()=>G,ramp:()=>X,range:()=>Y,text:()=>H,time:()=>L,toggle:()=>q,weighted:()=>O,xy:()=>Z});var K=a=>({type:"color",...a}),j=a=>({type:"choice",...a}),G=a=>({type:"datetime",randomize:!1,...a}),U=a=>({type:"date",randomize:!1,...a}),L=a=>({type:"time",randomize:!1,...a}),X=a=>({type:"ramp",randomize:!1,default:0,mode:"linear",stops:[[0,0],[1,1]],...a}),Y=a=>({type:"range",step:1,...a}),H=a=>({type:"text",randomize:!1,...a}),q=a=>({type:"toggle",...a}),O=a=>({type:"weighted",randomize:!1,...a,options:a.options.sort((t,e)=>e[0]-t[0]),total:a.options.reduce((t,e)=>t+e[0],0)}),Z=a=>({type:"xy",...a});var S=(a=0,t=0)=>{let e=performance.now(),r=t;return{start(s){e=performance.now(),r=t,s(a,t)},next(s){requestAnimationFrame(s)},tick(){return[a+performance.now()-e,++r]}}};var l={};g(l,{isNumber:()=>F,isNumericArray:()=>Q,isString:()=>J,u16:()=>P,u24:()=>T,u32:()=>ee,u8:()=>u});var F=a=>typeof a=="number"&&!isNaN(a),J=a=>typeof a=="string",Q=a=>Array.isArray(a)&&a.every(F),u=a=>(a&=255,(a<16?"0":"")+a.toString(16)),P=a=>u(a>>>8)+u(a),T=a=>P(a>>>8)+u(a&255),ee=a=>P(a>>>16)+P(a);var{isNumber:d,isString:p,isNumericArray:x}=l,{clamp:D,clamp01:C,mix:b,norm:E,round:z,parseNum:te}=h,R=class{id;_adapter;_time=S();_prng;_update;_state="init";_features;_params={};_paramTypes={choice:{valid:(t,e,r)=>t.options.find(s=>(Array.isArray(s)?s[0]:s)===r),randomize:(t,e)=>{let r=t.options,s=r[e()*r.length|0];return Array.isArray(s)?s[0]:s}},color:{valid:(t,e,r)=>p(r)&&/^#?[0-9a-f]{6}$/.test(r),coerce:(t,e)=>e[0]!=="#"?"#"+e:e,randomize:(t,e)=>"#"+T(e()*16777216|0)},date:{valid:(t,e,r)=>r instanceof Date||d(r)||p(r)&&/^\d{4}-\d{2}-\d{2}$/.test(r),coerce:(t,e)=>d(e)?new Date(e):p(e)?new Date(Date.parse(e)):e},datetime:{valid:(t,e,r)=>r instanceof Date||d(r)||p(r)&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[-+]\d{2}:\d{2})$/.test(r),coerce:(t,e)=>d(e)?new Date(e):p(e)?new Date(Date.parse(e)):e},time:{valid:(t,e,r)=>x(r)||p(r)&&/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(r),coerce:(t,e)=>p(e)?e.split(":").map(te):e},ramp:{valid:(t,e,r)=>e==="mode"?["linear","smooth","exp"].includes(r):Array.isArray(r)&&r.every(x),update:(t,e,r)=>{e==="mode"?t.mode=r:t.stops=r},read:(t,e)=>{let{stops:r,mode:s}=t,i=r.length,n=i;for(;n-- >0&&!(e>=r[n][0]););i--;let m=r[n],o=r[n+1];return n<0?r[0][1]:n>=i?r[i][1]:{exp:()=>b(m[1],o[1],y(E(e,m[0],o[0]))),linear:()=>_(e,m[0],o[0],m[1],o[1]),smooth:()=>b(m[1],o[1],c(E(e,m[0],o[0])))}[s||"linear"]()}},range:{valid:(t,e,r)=>{let{min:s,max:i}=t;return d(r)&&r>=s&&r<=i},coerce:(t,e)=>{let r=t;return D(z(e??r.default,r.step||1),r.min,r.max)},randomize:(t,e)=>{let{min:r,max:s,step:i}=t;return D(z(b(r,s,e()),i||1),r,s)}},text:{valid:(t,e,r)=>{if(!p(r))return!1;let{min:s,max:i,match:n}=t;return n&&!(p(n)?new RegExp(n):n).test(r)?!1:(!s||r.length>=s)&&(!i||r.length<=i)}},weighted:{valid:()=>!1,update:(t,e,r)=>{t.options=r},read:(t,e,r)=>{let{options:s,total:i,default:n}=t,m=r()*i;for(let o=0,I=s.length;o<I;o++)if(i-=s[o][0],i<=m)return s[o][1];return n}},xy:{valid:(t,e,r)=>x(r)&&r.length==2,coerce:(t,e)=>[C(e[0]),C(e[1])],randomize:(t,e)=>[e(),e()]}};math=h;params=w;utils=l;constructor(){window.addEventListener("message",t=>{let e=t.data;if(console.log("genart msg",e),!(!this.isRecipient(t)||e?.__self))switch(e.type){case"genart:start":this.start();break;case"genart:resume":this.start(!0);break;case"genart:stop":this.stop();break;case"genart:setparamvalue":this.setParamValue(e.paramID,e.value,e.key);break;case"genart:randomizeparam":this.randomizeParamValue(e.paramID)}})}get mode(){return this._adapter?.mode||"play"}get screen(){return this._adapter?.screen||{width:window.innerWidth,height:window.innerHeight,dpr:window.devicePixelRatio}}get random(){return this._prng?this._prng:this._prng=this.ensureAdapter().prng}get state(){return this._state}get paramSpecs(){return this._params}get adapter(){return this._adapter}get time(){return this._time}registerParamType(t,e){this._paramTypes[t]&&console.warn("overriding impl for param type:",t),this._paramTypes[t]=e}setParams(t){for(let e in t){let r=t[e];if(r.default==null){let s=this.ensureParamImpl(r.type);if(s.randomize)r.default=s.randomize(r,this.random.rnd);else throw new Error(`missing default value for param: ${e}`)}}return this._params=t,this._adapter&&this.updateParams(),this.notifySetParams(),(e,r)=>this.getParamValue(e,r)}setFeatures(t){this._features=t,this.emit({type:"genart:setfeatures",features:t})}setAdapter(t){this._adapter=t,this.updateParams(),this.notifySetParams(),this._state==="init"&&this._time&&(this._state="ready")}waitForAdapter(){return this.waitFor("_adapter")}setTimeProvider(t){this._time=t,this._state==="init"&&this._adapter&&(this._state="ready")}waitForTimeProvider(){return this.waitFor("_time")}setUpdate(t,e=!0){this._update=t,e&&this.start()}updateParams(t=!1){if(this._adapter)for(let e in this._params){let r=this._params[e],s=this._adapter?.updateParam(e,r);if(!s)continue;let{value:i,update:n}=s;this.setParamValue(e,i,void 0,t&&(i!=null||n))}}setParamValue(t,e,r,s=!0){let{spec:i,impl:n}=this.ensureParam(t);if(e!=null){if(!n.valid(i,r,e)){this.paramError(t);return}n.update?n.update(i,r,e):i.value=n.coerce?n.coerce(i,e):e}s&&this.emit({type:"genart:paramchange",paramID:t,spec:i,__self:!0})}randomizeParamValue(t,e=Math.random,r=!0){let{spec:s,impl:i}=this.ensureParam(t);i.randomize&&this.setParamValue(t,i.randomize(s,e),void 0,r)}getParamValue(t,e=0){let r=this._params[t];if(!r)throw new Error(`unknown param: ${t}`);let s=this._paramTypes[r.type].read;return s?s(r,e,this.random.rnd):r.value??r.default}paramError(t){this.emit({type:"genart:paramerror",paramID:t})}on(t,e){window.addEventListener("message",r=>{this.isRecipient(r)&&r.data?.type===t&&e(r.data)})}emit(t,e="all"){this.id&&(t.apiID=this.id),(e==="all"||e==="self")&&window.postMessage(t,"*"),(e==="all"&&parent!==window||e==="parent")&&parent.postMessage(t,"*")}start(t=!1){if(this._state=="play")return;if(this._state!=="ready"&&this._state!=="stop")throw new Error(`can't start in state: ${this._state}`);if(!this._update)throw new Error("missing update function");this.ensureTimeProvider(),this._state="play";let e=()=>{this._state=="play"&&(this._update.call(null,...this._time.tick()),this._time.next(e))};t?e():this._time.start(e),this.emit({type:`genart:${t?"resume":"start"}`,__self:!0})}stop(){this._state==="play"&&(this._state="stop",this.emit({type:"genart:stop",__self:!0}))}capture(t){this._adapter?.capture(t),this.emit({type:"genart:capture",__self:!0},"parent")}ensureAdapter(){if(!this._adapter)throw new Error("missing platform adapter");return this._adapter}ensureTimeProvider(){if(!this._time)throw new Error("missing time provider");return this._time}ensureParam(t){let e=this._params[t];if(!e)throw new Error(`unknown param: ${t}`);let r=this.ensureParamImpl(e.type);return{spec:e,impl:r}}ensureParamImpl(t){let e=this._paramTypes[t];if(!e)throw new Error(`unknown param type: ${t}`);return e}waitFor(t){return this[t]?Promise.resolve():new Promise(e=>{let r=()=>{this[t]?e():setTimeout(r,0)};r()})}notifySetParams(){Object.keys(this._params).length&&this.emit({type:"genart:setparams",__self:!0,params:this._params})}isRecipient({data:t}){return t!=null&&typeof t=="object"&&(!this.id||this.id===t.apiID)}};globalThis.$genart=new R;})();
