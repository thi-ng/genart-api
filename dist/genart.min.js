"use strict";(()=>{var _e=Object.defineProperty;var z=(r,t)=>{for(var e in t)_e(r,e,{get:t[e],enumerable:!0})};var E={};z(E,{clamp:()=>we,clamp01:()=>ie,div:()=>V,easeInOut5:()=>K,fit:()=>O,mix:()=>Ae,norm:()=>oe,parseNum:()=>be,round:()=>Me,smoothstep:()=>Re,smoothstep01:()=>D});var be=(r,t=0)=>{let e=r?parseFloat(r):Number.NaN;return isNaN(e)?t:e},Ae=(r,t,e)=>r+(t-r)*e,O=(r,t,e,a,s)=>a+(s-a)*oe(r,t,e),we=(r,t,e)=>r<t?t:r>e?e:r,ie=r=>r<0?0:r>1?1:r,Me=(r,t)=>Math.round(V(r,t))*t,oe=(r,t,e)=>V(r-t,e-t),V=(r,t)=>t!=0?r/t:0,Re=(r,t,e)=>D(ie(V(e-r,t-r))),D=r=>r*r*(3-2*r),Se=r=>{let t=2**(r-1);return e=>e<.5?t*e**r:1-(-2*e+2)**r/2},K=Se(5);var H={};z(H,{choice:()=>q,color:()=>Ce,date:()=>Ve,datetime:()=>ze,image:()=>De,numlist:()=>X,ramp:()=>Ee,range:()=>ke,strlist:()=>Le,text:()=>$e,time:()=>Ge,toggle:()=>Ue,vector:()=>je,weighted:()=>Be,xy:()=>Oe});var $={};z($,{ensure:()=>_,equiv:()=>le,equivArrayLike:()=>ue,formatValuePrec:()=>Fe,isFunction:()=>ve,isNumber:()=>v,isNumericArray:()=>Ie,isString:()=>me,isTypedArray:()=>pe,u16:()=>L,u24:()=>W,u32:()=>Ne,u8:()=>k,valuePrec:()=>de});var _=(r,t)=>{if(!r)throw new Error(t);return r},v=r=>typeof r=="number"&&!isNaN(r),me=r=>typeof r=="string",ve=r=>typeof r=="function",Ie=r=>pe(r)||Array.isArray(r)&&r.every(v),pe=r=>!!r&&(r instanceof Float32Array||r instanceof Float64Array||r instanceof Uint32Array||r instanceof Int32Array||r instanceof Uint8Array||r instanceof Int8Array||r instanceof Uint16Array||r instanceof Int16Array||r instanceof Uint8ClampedArray),k=r=>(r&=255,(r<16?"0":"")+r.toString(16)),L=r=>k(r>>>8)+k(r),W=r=>L(r>>>8)+k(r&255),Ne=r=>L(r>>>16)+L(r),de=r=>{let t=r.toString(),e=t.indexOf(".");return e>0?t.length-e-1:0},Fe=r=>{let t=de(r);return e=>e.toFixed(t)},le=(r,t)=>r===t?!0:r==null?t==null:t==null?r==null:me(r)||v(r)?r===t:r instanceof Date&&t instanceof Date?r.getTime()===t.getTime():r instanceof RegExp&&t instanceof RegExp?r.toString()===t.toString():r.length!=null&&t.length!=null?ue(r,t):r===t||r!==r&&t!==t,ue=(r,t)=>{if(r.length!==t.length)return!1;let e=r.length;for(;e-- >0&&le(r[e],t[e]););return e<0};var l=(r,t,e=!0)=>({type:r,state:"void",randomize:e,...t}),q=r=>l("choice",r),Ce=r=>l("color",r),ze=r=>l("datetime",r,!1),Ve=r=>l("date",r,!1),De=r=>l("img",{default:r.default||new Uint8Array(r.width*r.height),...r},!1),X=r=>l("numlist",{default:[],...r},!1),Ee=r=>l("ramp",{name:r.name,desc:r.desc,doc:r.doc,stops:r.stops?r.stops.flat():[0,0,1,1],mode:r.mode||"linear",default:0},!1),ke=r=>l("range",{min:0,max:100,step:1,...r}),Le=r=>l("strlist",{default:[],...r},!1),$e=r=>l("text",r,!1),Ge=r=>l("time",r),Ue=r=>l("toggle",r),je=r=>{let t=(e,a,s=0)=>Array.isArray(a)?(_(a.length===e,"wrong vector size"),a):new Array(e).fill(v(a)?a:s);return r.default&&_(r.default.length==r.size,`wrong vector size, expected ${r.size} values`),r.labels?_(r.labels.length>=r.size,`expected ${r.size} labels`):_(r.size<=4,"missing vector labels"),l("vector",{...r,min:t(r.size,r.min,0),max:t(r.size,r.max,1),step:t(r.size,r.step,.01),labels:r.labels||["X","Y","Z","W"].slice(0,r.size)})},Be=r=>l("weighted",{...r,options:r.options.sort((t,e)=>e[0]-t[0]),total:r.options.reduce((t,e)=>t+e[0],0)}),Oe=r=>l("xy",r);var Y={};z(Y,{sfc32:()=>Ke,xorshift128:()=>We,xsadd:()=>qe});var Ke=r=>{let t=new Uint32Array(4);return t.set(r),()=>{let e=(t[0]+t[1]>>>0)+t[3]>>>0;return t[3]=t[3]+1>>>0,t[0]=t[1]^t[1]>>>9,t[1]=t[2]+(t[2]<<3)>>>0,t[2]=(t[2]<<21|t[2]>>>11)+e>>>0,e/4294967296}},We=r=>{let t=new Uint32Array(4);return t.set(r),()=>{let e=t[3],a;return e^=e<<11,e^=e>>>8,t[3]=t[2],t[2]=t[1],a=t[1]=t[0],t[0]=(e^a^a>>>19)>>>0}},qe=r=>{let t=new Uint32Array(4);t.set([r,0,0,0]);for(let e=0,a=1;a<8;e=a++){let s=(t[e&3]^t[e&3]>>>30)>>>0;s=35173*s+((27655*s&65535)<<16)>>>0,t[a&3]^=a+s>>>0}return()=>{let e=t[0];return e^=e<<15,e^=e>>>18,e^=t[3]<<11,t[0]=t[1],t[1]=t[2],t[2]=t[3],t[3]=e,e+t[2]>>>0}};var ce=(r,t,e=[])=>({head:()=>r[e[0]],push(a){for(;e.length&&t(r[e[e.length-1]],a);)e.pop();e.push(r.length-1)},shift(){e[0]===0&&e.shift();for(let a=e.length;a-- >0;)e[a]--}}),fe=({targetFPS:r=60,period:t=200,width:e=t,height:a=100,style:s="position:fixed;z-index:9999;top:0;right:0;",bg:n="#222",text:i="#fff",fps:o=["#0f0","#ff0","#f00","#306"],fill:p=!0}={})=>{let d,m,te=e/t,ye=e>=120,re=performance.now(),w=0,h=0,ae=0,y=[],N,M,c=r,F=0,se=!0,Te=()=>{let g=[h,w],P=h-ae;if(ae=h,P<=0)return g;let C=1e3/P,R=y.push(C);N.push(C),M.push(C),R>t&&(R--,F-=y.shift(),N.shift(),M.shift()),F+=C;let{clamp01:B,round:xe}=$genart.math;c+=(M.head()*1.1-c)*.1;let S=m.createLinearGradient(0,0,0,d.height);S.addColorStop(B(1-r/c),o[0]),S.addColorStop(B(1-(r-1)/c),o[1]),S.addColorStop(B(1-r/2/c),o[2]),S.addColorStop(1,o[3]),m.fillStyle=n,m.fillRect(0,0,e,a),m[p?"fillStyle":"strokeStyle"]=S,m.setLineDash([]),m.beginPath(),m.moveTo(-1,a);for(let f=0;f<R;f++)m.lineTo(f*te,(1-y[f]/c)*a);p?(m.lineTo((R-1)*te,a),m.closePath(),m.fill()):m.stroke(),m.fillStyle=m.strokeStyle=i,m.setLineDash([1,1]),m.beginPath();for(let f=c>90?30:c>30?15:5,T=xe(Math.min(r,c+f/2),f);T>0;T-=f){let x=(1-T/c)*a;m.moveTo(e-80,x),ye?(m.lineTo(e-22,x),m.fillText(String(T),e-20,x+1)):m.lineTo(e,x)}return m.stroke(),R>=t&&[[`sma(${t}):`,F/t],["max:",M.head()],["min:",N.head()]].forEach(([f,T],x)=>{let ne=a-8-x*12;m.fillText(f,4,ne),m.fillText(T.toFixed(1)+" fps",64,ne)}),g};return{start(){y=[],N=ce(y,(g,P)=>g>=P),M=ce(y,(g,P)=>g<=P),c=r*1.2,F=0,d||(d=document.createElement("canvas"),d.width=e,d.height=a,d.id="#FPS",d.setAttribute("style",s),document.body.appendChild(d),m=d.getContext("2d"),m.font="12px sans-serif",m.textBaseline="middle",m.strokeStyle=i,m.setLineDash([1,1]))},next(g){requestAnimationFrame(P=>{se?(re=P,w=0,se=!1):w++,h=P-re,g(h,w),Te()})},now(){return[h,w]}}};var Pe=(r=250,t=60,e=0)=>{let a=e,s=1e3/t;return{start(){a=e-1},next(n){setTimeout(()=>{a++,n(a*s,a)},r)},now:()=>[a*s,a]}};var Z=(r=0,t=0)=>{let e=performance.now(),a=t,s=r,n=!0;return{start(){n=!0},next(i){requestAnimationFrame(o=>{n?(e=o,a=t,n=!1):a++,s=r+o-e,i(s,a)})},now:()=>[s,a]}};var{ensure:A,isFunction:Xe,isNumber:b,isNumericArray:I,isString:u}=$,{clamp:G,clamp01:ge,mix:U,norm:he,parseNum:He,round:j}=E,Ye={edit:"protected",group:"main",order:0,randomize:!0,update:"event",widget:"default"},Q=class{_opts={id:Math.floor(Math.random()*1e12).toString(36),allowExternalConfig:!1,notifyFrameUpdate:!1};_adapter;_time=Z();_prng;_update;_state="init";_traits;_params;_paramTypes={choice:{validate:(t,e)=>!!t.options.find(a=>(Array.isArray(a)?a[0]:a)===e),randomize:(t,e)=>{let a=t.options,s=a[e()*a.length|0];return Array.isArray(s)?s[0]:s}},color:{validate:(t,e)=>u(e)&&/^#?[0-9a-f]{6}$/.test(e),coerce:(t,e)=>e[0]!=="#"?"#"+e:e,randomize:(t,e)=>"#"+W(e()*16777216|0)},date:{validate:(t,e)=>e instanceof Date||b(e)||u(e)&&/^\d{4}-\d{2}-\d{2}$/.test(e),coerce:(t,e)=>b(e)?new Date(e):u(e)?new Date(Date.parse(e)):e},datetime:{validate:(t,e)=>e instanceof Date||b(e)||u(e)&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[-+]\d{2}:\d{2})$/.test(e),coerce:(t,e)=>b(e)?new Date(e):u(e)?new Date(Date.parse(e)):e},img:{validate:(t,e)=>{let{width:a,height:s}=t;return I(e)&&e.length==a*s}},numlist:{validate:(t,e)=>{if(!I(e))return!1;let{min:a=0,max:s=1/0}=t;return e.length>=a&&e.length<=s}},ramp:{validate:()=>!1,read:(t,e)=>{let{stops:a,mode:s}=t,n=a.length,i=n;for(;(i-=2)>=0&&!(e>=a[i]););n-=2;let o=a[i],p=a[i+1],d=a[i+2],m=a[i+3];return i<0?a[1]:i>=n?a[n+1]:{exp:()=>U(p,m,K(he(e,o,d))),linear:()=>O(e,o,d,p,m),smooth:()=>U(p,m,D(he(e,o,d)))}[s||"linear"]()},params:{stops:X({name:"Ramp stops",desc:"Control points",default:[]}),mode:q({name:"Ramp mode",desc:"Interpolation method",options:["linear","smooth","exp"]})}},range:{validate:(t,e)=>{let{min:a,max:s}=t;return b(e)&&e>=a&&e<=s},coerce:(t,e)=>{let a=t;return G(j(e??a.default,a.step||1),a.min,a.max)},randomize:(t,e)=>{let{min:a,max:s,step:n}=t;return G(j(U(a,s,e()),n||1),a,s)}},strlist:{validate:(t,e)=>{let{min:a=0,max:s=1/0,match:n}=t;if(!(Array.isArray(e)&&e.length>=a&&e.length<=s&&e.every(u)))return!1;if(n){let i=u(n)?new RegExp(n):n;return e.every(o=>i.test(o))}return!0}},text:{validate:(t,e)=>{if(!u(e))return!1;let{min:a,max:s,match:n}=t;return n&&!(u(n)?new RegExp(n):n).test(e)?!1:(!a||e.length>=a)&&(!s||e.length<=s)}},time:{validate:(t,e)=>I(e)||u(e)&&/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(e),coerce:(t,e)=>u(e)?e.split(":").map(He):e,randomize:(t,e)=>[e()*24|0,e()*60|0,e()*60|0]},toggle:{validate:(t,e)=>u(e)?/^(true|false|0|1)$/.test(e):b(e)||typeof e=="boolean",coerce:(t,e)=>e==="true"||e==="1"?!0:e==="false"||e==="0"?!1:!!e,randomize:(t,e)=>e()<.5},vector:{validate:(t,e)=>{let{min:a,max:s,size:n}=t;return I(e)&&e.length===n&&e.every((i,o)=>i>=a[o]&&i<=s[o])},coerce:(t,e)=>{let{min:a,max:s,step:n}=t;return e.map((i,o)=>G(j(i,n[o]),a[o],s[o]))},randomize:(t,e)=>{let{min:a,max:s,size:n,step:i}=t;return new Array(n).fill(0).map((o,p)=>G(j(U(a[p],s[p],e()),i[p]),a[p],s[p]))}},weighted:{validate:(t,e)=>!!t.options.find(a=>a[1]===e),randomize:(t,e)=>{let{options:a,total:s,default:n}=t,i=e()*s;for(let o=0,p=a.length;o<p;o++)if(s-=a[o][0],s<=i)return a[o][1];return n}},xy:{validate:(t,e)=>I(e)&&e.length==2,coerce:(t,e)=>[ge(e[0]),ge(e[1])],randomize:(t,e)=>[e(),e()]}};math=E;params=H;prng=Y;utils=$;time={debug:fe,offline:Pe,raf:Z};constructor(){window.addEventListener("message",t=>{let e=t.data;if(!(!this.isRecipient(t)||e?.__self))switch(e.type){case"genart:get-info":this.notifyInfo();break;case"genart:randomize-param":this.randomizeParamValue(e.paramID,e.key);break;case"genart:resume":this.start(!0);break;case"genart:configure":{let a=e.opts;delete a.id,delete a.allowExternalConfig,this.configure(a);break}case"genart:set-param-value":this.setParamValue(e.paramID,e.value,e.key);break;case"genart:start":this.start();break;case"genart:stop":this.stop();break}})}get version(){return"0.20.0"}get id(){return this._opts.id}get mode(){return this._adapter?.mode||"play"}get screen(){return this._adapter?.screen||{width:window.innerWidth,height:window.innerHeight,dpr:window.devicePixelRatio}}get random(){return this._prng?this._prng:this._prng=A(this._adapter,"missing platform adapter").prng}get state(){return this._state}get paramSpecs(){return this._params}get adapter(){return this._adapter}get timeProvider(){return this._time}registerParamType(t,e){J(t),this._paramTypes[t]&&console.warn("overriding impl for param type:",t),this._paramTypes[t]=e}paramType(t){return J(t),this._paramTypes[t]}async setParams(t){try{this._adapter?.augmentParams&&(t=this._adapter.augmentParams(t)),this._params={};for(let e in t){ee(e);let a={...Ye,...t[e]};if(a.default==null){let s=this.ensureParamImpl(a.type);if(s.randomize)a.default=s.randomize(a,this.random.rnd),a.state="random";else if(s.read)a.state="dynamic";else throw new Error(`missing default value for param: ${e}`)}else a.state="default";this._params[e]=a}return this._adapter&&(this._adapter.initParams&&await this._adapter.initParams(this._params),await this.updateParams()),this.notifySetParams(),this.getParamValue.bind(this)}catch(e){throw this.setState("error",e.message),e}}setTraits(t){this._traits=t,this.emit({type:"genart:traits",traits:t})}async setAdapter(t){this._adapter=t,this.notifyReady()}waitForAdapter(){return this.waitFor("_adapter")}setTimeProvider(t){this._time=t,this.notifyReady()}waitForTimeProvider(){return this.waitFor("_time")}setUpdate(t){this._update=t,this.notifyReady()}async updateParams(t="none"){if(this._adapter)for(let e in this._params){let a=this._params[e],s=await this._adapter.updateParam(e,a);if(!s)continue;let{value:n,update:i}=s;if(i)for(let o in i)this.setParamValue(e,i[o],o,"none");this.setParamValue(e,n,void 0,n!=null||i?t:"none")}}setParamValue(t,e,a,s="all"){let{spec:n,impl:i}=this.ensureParam(t);if(e!=null){let o=n;if(a){let{spec:p,impl:d}=this.ensureNestedParam(n,a);o=p,i=d}if(!i.validate(o,e)){this.paramError(t);return}n[a||"value"]=i.coerce?i.coerce(o,e):e,a||(n.state="custom")}this.emit({type:"genart:param-change",__self:!0,param:this.asNestedParam(n),paramID:t,key:a},s)}randomizeParamValue(t,e,a=Math.random,s="all"){let{spec:n,impl:{randomize:i}}=this.ensureParam(t),o=i&&n.randomize!==!1;if(e){let{spec:p,impl:d}=this.ensureNestedParam(n,e),m=d.randomize&&p.randomize!==!1;m&&this.setParamValue(t,d.randomize(p,a),e,m||!o?s:"none")}o&&this.setParamValue(t,i(n,a),void 0,s)}getParamValue(t,e){return this.paramValueGetter(t)(e)}paramValueGetter(t){let{spec:e,impl:{randomize:a,read:s}}=this.ensureParam(t);return(n=0)=>{if(Xe(n)){if(a)return a(e,n);n=0}return s?s(e,n):e.value??e.default}}paramError(t){this.emit({type:"genart:param-error",paramID:t})}configure(t){Object.assign(this._opts,t),this.notifyInfo()}on(t,e){window.addEventListener("message",a=>{this.isRecipient(a)&&a.data?.type===t&&e(a.data)})}emit(t,e="all"){if(e==="none")return;t.apiID=this.id;let a=e==="all";(a||e==="self")&&window.postMessage(t,"*"),(a&&parent!==window||e==="parent")&&parent.postMessage(t,"*")}start(t=!1){let e=this._state;if(e=="play")return;if(e!=="ready"&&e!=="stop")throw new Error(`can't start in state: ${e}`);this.setState("play");let a={type:"genart:frame",__self:!0,apiID:this.id,time:0,frame:0},s=(n,i)=>{this._state=="play"&&(this._update.call(null,n,i)?this._time.next(s):this.stop(),this._opts.notifyFrameUpdate&&(a.time=n,a.frame=i,this.emit(a)))};t||this._time.start(),this._time.next(s),this.emit({type:`genart:${t?"resume":"start"}`,__self:!0})}stop(){this._state==="play"&&(this.setState("stop"),this.emit({type:"genart:stop",__self:!0}))}capture(t){this._adapter?.capture(t),this.emit({type:"genart:capture",__self:!0},"parent")}setState(t,e){this._state=t,this.emit({type:"genart:state-change",__self:!0,state:t,info:e})}ensureParam(t){ee(t);let e=A(A(this._params,"no params defined")[t],`unknown param: ${t}`);return{spec:e,impl:this.ensureParamImpl(e.type)}}ensureParamImpl(t){return J(t),A(this._paramTypes[t],`unknown param type: ${t}`)}ensureNestedParam(t,e){let a=A(this.ensureParamImpl(t.type).params?.[e],`param type '${t.type}' has no nested: ${e}`);return{spec:a,impl:this.ensureParamImpl(a.type)}}waitFor(t){return this[t]?Promise.resolve():new Promise(e=>{let a=()=>{this[t]?e():setTimeout(a,0)};a()})}notifySetParams(){this._params&&Object.keys(this._params).length&&this.emit({type:"genart:params",__self:!0,params:this.asNestedParams({},this._params)})}notifyReady(){this._state==="init"&&this._adapter&&this._time&&this._update&&this.setState("ready")}notifyInfo(){let[t,e]=this._time.now();this.emit({type:"genart:info",opts:this._opts,state:this._state,version:this.version,adapter:this._adapter?.id,seed:this.random.seed,time:t,frame:e})}isRecipient({data:t}){return t!=null&&typeof t=="object"&&(t.apiID===this.id||t.apiID==="*")}asNestedParams(t,e){for(let a in e)t[a]=this.asNestedParam(e[a]);return t}asNestedParam(t){let e={...t},a=this._paramTypes[t.type];return a.params&&(e.__params=this.asNestedParams({},a.params)),e}},ee=(r,t="ID")=>A(!(r==="__proto__"||r==="prototype"||r==="constructor"),`illegal param ${t}: ${r}`),J=r=>ee(r,"type");globalThis.$genart=new Q;})();
