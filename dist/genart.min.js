"use strict";(()=>{var he=Object.defineProperty;var U=(a,t)=>{for(var e in t)he(a,e,{get:t[e],enumerable:!0})};var F={};U(F,{clamp:()=>be,clamp01:()=>ie,div:()=>D,easeInOut5:()=>K,fit:()=>B,mix:()=>Te,norm:()=>ne,parseNum:()=>ye,round:()=>_e,smoothstep:()=>xe,smoothstep01:()=>V});var ye=(a,t=0)=>{let e=a?parseFloat(a):Number.NaN;return isNaN(e)?t:e},Te=(a,t,e)=>a+(t-a)*e,B=(a,t,e,r,s)=>r+(s-r)*ne(a,t,e),be=(a,t,e)=>a<t?t:a>e?e:a,ie=a=>a<0?0:a>1?1:a,_e=(a,t)=>Math.round(D(a,t))*t,ne=(a,t,e)=>D(a-t,e-t),D=(a,t)=>t!=0?a/t:0,xe=(a,t,e)=>V(ie(D(e-a,t-a))),V=a=>a*a*(3-2*a),Ae=a=>{let t=2**(a-1);return e=>e<.5?t*e**a:1-(-2*e+2)**a/2},K=Ae(5);var H={};U(H,{choice:()=>q,color:()=>Se,date:()=>Ne,datetime:()=>Re,image:()=>Ce,numlist:()=>X,ramp:()=>De,range:()=>Ve,strlist:()=>Fe,text:()=>ze,time:()=>Ee,toggle:()=>$e,vector:()=>ke,weighted:()=>Ge,xy:()=>je});var k={};U(k,{ensure:()=>_,formatValuePrec:()=>Ie,isNumber:()=>$,isNumericArray:()=>Me,isString:()=>ve,isTypedArray:()=>oe,u16:()=>E,u24:()=>W,u32:()=>we,u8:()=>z,valuePrec:()=>me});var _=(a,t)=>{if(!a)throw new Error(t);return a},$=a=>typeof a=="number"&&!isNaN(a),ve=a=>typeof a=="string",Me=a=>oe(a)||Array.isArray(a)&&a.every($),oe=a=>!!a&&(a instanceof Float32Array||a instanceof Float64Array||a instanceof Uint32Array||a instanceof Int32Array||a instanceof Uint8Array||a instanceof Int8Array||a instanceof Uint16Array||a instanceof Int16Array||a instanceof Uint8ClampedArray),z=a=>(a&=255,(a<16?"0":"")+a.toString(16)),E=a=>z(a>>>8)+z(a),W=a=>E(a>>>8)+z(a&255),we=a=>E(a>>>16)+E(a),me=a=>{let t=a.toString(),e=t.indexOf(".");return e>0?t.length-e-1:0},Ie=a=>{let t=me(a);return e=>e.toFixed(t)};var l=(a,t,e=!0)=>({type:a,state:"void",randomize:e,...t}),q=a=>l("choice",a),Se=a=>l("color",a),Re=a=>l("datetime",a,!1),Ne=a=>l("date",a,!1),Ce=a=>l("img",{default:a.default||new Uint8Array(a.width*a.height),...a},!1),X=a=>l("numlist",{default:[],...a},!1),De=a=>l("ramp",{name:a.name,desc:a.desc,doc:a.doc,stops:a.stops?a.stops.flat():[0,0,1,1],mode:a.mode||"linear",default:0},!1),Ve=a=>l("range",{min:0,max:100,step:1,...a}),Fe=a=>l("strlist",{default:[],...a},!1),ze=a=>l("text",a,!1),Ee=a=>l("time",a),$e=a=>l("toggle",a),ke=a=>{let t=(e,r,s=0)=>Array.isArray(r)?(_(r.length===e,"wrong vector size"),r):new Array(e).fill($(r)?r:s);return a.default&&_(a.default.length==a.dim,`wrong vector size, expected ${a.dim} values`),a.labels?_(a.labels.length>=a.dim,`expected ${a.dim} labels`):_(a.dim<=4,"missing vector labels"),l("vector",{...a,min:t(a.dim,a.min,0),max:t(a.dim,a.max,1),step:t(a.dim,a.step,.01),labels:a.labels||["X","Y","Z","W"].slice(0,a.dim)})},Ge=a=>l("weighted",{...a,options:a.options.sort((t,e)=>e[0]-t[0]),total:a.options.reduce((t,e)=>t+e[0],0)}),je=a=>l("xy",a);var pe=(a,t,e=[])=>({head:()=>a[e[0]],push(r){for(;e.length&&t(a[e[e.length-1]],r);)e.pop();e.push(a.length-1)},shift(){e[0]===0&&e.shift();for(let r=e.length;r-- >0;)e[r]--}}),de=({targetFPS:a=60,period:t=200,width:e=t,height:r=100,style:s="position:fixed;z-index:9999;top:0;right:0;",bg:i="#222",text:n="#fff",fps:m=["#0f0","#ff0","#f00","#306"],fill:p=!0}={})=>{let d,o,ee=e/t,ue=e>=120,te=performance.now(),v=0,h=0,ae=0,y=[],R,M,c=a,N=0,re=!0,Pe=()=>{let g=[h,v],P=h-ae;if(ae=h,P<=0)return g;let C=1e3/P,w=y.push(C);R.push(C),M.push(C),w>t&&(w--,N-=y.shift(),R.shift(),M.shift()),N+=C;let{clamp01:O,round:ge}=$genart.math;c+=(M.head()*1.1-c)*.1;let I=o.createLinearGradient(0,0,0,d.height);I.addColorStop(O(1-a/c),m[0]),I.addColorStop(O(1-(a-1)/c),m[1]),I.addColorStop(O(1-a/2/c),m[2]),I.addColorStop(1,m[3]),o.fillStyle=i,o.fillRect(0,0,e,r),o[p?"fillStyle":"strokeStyle"]=I,o.setLineDash([]),o.beginPath(),o.moveTo(-1,r);for(let u=0;u<w;u++)o.lineTo(u*ee,(1-y[u]/c)*r);p?(o.lineTo((w-1)*ee,r),o.closePath(),o.fill()):o.stroke(),o.fillStyle=o.strokeStyle=n,o.setLineDash([1,1]),o.beginPath();for(let u=c>90?30:c>30?15:5,T=ge(Math.min(a,c+u/2),u);T>0;T-=u){let b=(1-T/c)*r;o.moveTo(e-80,b),ue?(o.lineTo(e-22,b),o.fillText(String(T),e-20,b+1)):o.lineTo(e,b)}return o.stroke(),w>=t&&[[`sma(${t}):`,N/t],["max:",M.head()],["min:",R.head()]].forEach(([u,T],b)=>{let se=r-8-b*12;o.fillText(u,4,se),o.fillText(T.toFixed(1)+" fps",64,se)}),g};return{start(){y=[],R=pe(y,(g,P)=>g>=P),M=pe(y,(g,P)=>g<=P),c=a*1.2,N=0,d||(d=document.createElement("canvas"),d.width=e,d.height=r,d.id="#FPS",d.setAttribute("style",s),document.body.appendChild(d),o=d.getContext("2d"),o.font="12px sans-serif",o.textBaseline="middle",o.strokeStyle=n,o.setLineDash([1,1]))},next(g){requestAnimationFrame(P=>{re?(te=P,v=0,re=!1):v++,h=P-te,g(h,v),Pe()})},now(){return[h,v]}}};var le=(a=250,t=60,e=0)=>{let r=e,s=1e3/t;return{start(){r=e-1},next(i){setTimeout(()=>{r++,i(r*s,r)},a)},now:()=>[r*s,r]}};var Y=(a=0,t=0)=>{let e=performance.now(),r=t,s=a,i=!0;return{start(){i=!0},next(n){requestAnimationFrame(m=>{i?(e=m,r=t,i=!1):r++,s=a+m-e,n(s,r)})},now:()=>[s,r]}};var{ensure:A,isNumber:x,isString:f,isNumericArray:S}=k,{clamp:G,clamp01:ce,mix:j,norm:fe,round:L,parseNum:Le}=F,Oe={edit:"protected",group:"main",order:0,randomize:!0,update:"event",widget:"default"},J=class{_opts={id:Math.floor(Math.random()*1e12).toString(36),allowExternalConfig:!1,notifyFrameUpdate:!1};_adapter;_time=Y();_prng;_update;_state="init";_traits;_params;_paramTypes={choice:{validate:(t,e)=>!!t.options.find(r=>(Array.isArray(r)?r[0]:r)===e),randomize:(t,e)=>{let r=t.options,s=r[e()*r.length|0];return Array.isArray(s)?s[0]:s}},color:{validate:(t,e)=>f(e)&&/^#?[0-9a-f]{6}$/.test(e),coerce:(t,e)=>e[0]!=="#"?"#"+e:e,randomize:(t,e)=>"#"+W(e()*16777216|0)},date:{validate:(t,e)=>e instanceof Date||x(e)||f(e)&&/^\d{4}-\d{2}-\d{2}$/.test(e),coerce:(t,e)=>x(e)?new Date(e):f(e)?new Date(Date.parse(e)):e},datetime:{validate:(t,e)=>e instanceof Date||x(e)||f(e)&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[-+]\d{2}:\d{2})$/.test(e),coerce:(t,e)=>x(e)?new Date(e):f(e)?new Date(Date.parse(e)):e},img:{validate:(t,e)=>{let{width:r,height:s}=t;return S(e)&&e.length==r*s}},numlist:{validate:(t,e)=>S(e)},ramp:{validate:()=>!1,read:(t,e)=>{let{stops:r,mode:s}=t,i=r.length,n=i;for(;(n-=2)>=0&&!(e>=r[n]););i-=2;let m=r[n],p=r[n+1],d=r[n+2],o=r[n+3];return n<0?r[1]:n>=i?r[i+1]:{exp:()=>j(p,o,K(fe(e,m,d))),linear:()=>B(e,m,d,p,o),smooth:()=>j(p,o,V(fe(e,m,d)))}[s||"linear"]()},params:{stops:X({name:"Ramp stops",desc:"Control points",default:[]}),mode:q({name:"Ramp mode",desc:"Interpolation method",options:["linear","smooth","exp"]})}},range:{validate:(t,e)=>{let{min:r,max:s}=t;return x(e)&&e>=r&&e<=s},coerce:(t,e)=>{let r=t;return G(L(e??r.default,r.step||1),r.min,r.max)},randomize:(t,e)=>{let{min:r,max:s,step:i}=t;return G(L(j(r,s,e()),i||1),r,s)}},strlist:{validate:(t,e)=>Array.isArray(e)&&e.every(f)},text:{validate:(t,e)=>{if(!f(e))return!1;let{min:r,max:s,match:i}=t;return i&&!(f(i)?new RegExp(i):i).test(e)?!1:(!r||e.length>=r)&&(!s||e.length<=s)}},time:{validate:(t,e)=>S(e)||f(e)&&/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(e),coerce:(t,e)=>f(e)?e.split(":").map(Le):e,randomize:(t,e)=>[e()*24|0,e()*60|0,e()*60|0]},toggle:{validate:(t,e)=>f(e)?/^(true|false|0|1)$/.test(e):x(e)||typeof e=="boolean",coerce:(t,e)=>e==="true"||e==="1"?!0:e==="false"||e==="0"?!1:!!e,randomize:(t,e)=>e()<.5},vector:{validate:(t,e)=>{let{dim:r,min:s,max:i}=t;return S(e)&&e.length===r&&e.every((n,m)=>n>=s[m]&&n<=i[m])},coerce:(t,e)=>{let{min:r,max:s,step:i}=t;return e.map((n,m)=>G(L(n,i[m]),r[m],s[m]))},randomize:(t,e)=>{let{dim:r,min:s,max:i,step:n}=t;return new Array(r).fill(0).map((m,p)=>G(L(j(s[p],i[p],e()),n[p]),s[p],i[p]))}},weighted:{validate:(t,e)=>!!t.options.find(r=>r[1]===e),randomize:(t,e)=>{let{options:r,total:s,default:i}=t,n=e()*s;for(let m=0,p=r.length;m<p;m++)if(s-=r[m][0],s<=n)return r[m][1];return i}},xy:{validate:(t,e)=>S(e)&&e.length==2,coerce:(t,e)=>[ce(e[0]),ce(e[1])],randomize:(t,e)=>[e(),e()]}};math=F;params=H;utils=k;time={debug:de,offline:le,raf:Y};constructor(){window.addEventListener("message",t=>{let e=t.data;if(!(!this.isRecipient(t)||e?.__self))switch(e.type){case"genart:get-info":this.notifyInfo();break;case"genart:randomize-param":this.randomizeParamValue(e.paramID,e.key);break;case"genart:resume":this.start(!0);break;case"genart:configure":{let r=e.opts;delete r.id,delete r.allowExternalConfig,this.configure(r);break}case"genart:set-param-value":this.setParamValue(e.paramID,e.value,e.key);break;case"genart:start":this.start();break;case"genart:stop":this.stop();break}})}get version(){return"0.15.0"}get id(){return this._opts.id}get mode(){return this._adapter?.mode||"play"}get screen(){return this._adapter?.screen||{width:window.innerWidth,height:window.innerHeight,dpr:window.devicePixelRatio}}get random(){return this._prng?this._prng:this._prng=A(this._adapter,"missing platform adapter").prng}get state(){return this._state}get paramSpecs(){return this._params}get adapter(){return this._adapter}get timeProvider(){return this._time}registerParamType(t,e){Z(t),this._paramTypes[t]&&console.warn("overriding impl for param type:",t),this._paramTypes[t]=e}paramType(t){return Z(t),this._paramTypes[t]}async setParams(t){try{this._adapter?.augmentParams&&(t=this._adapter.augmentParams(t)),this._params={};for(let e in t){Q(e);let r={...Oe,...t[e]};if(r.default==null){let s=this.ensureParamImpl(r.type);if(s.randomize)r.default=s.randomize(r,this.random.rnd),r.state="random";else if(s.read)r.state="dynamic";else throw new Error(`missing default value for param: ${e}`)}else r.state="default";this._params[e]=r}return this._adapter&&(this._adapter.initParams&&await this._adapter.initParams(this._params),await this.updateParams()),this.notifySetParams(),(e,r,s)=>this.getParamValue(e,r,s)}catch(e){throw this.setState("error",e.message),e}}setTraits(t){this._traits=t,this.emit({type:"genart:traits",traits:t})}async setAdapter(t){this._adapter=t,this.notifyReady()}waitForAdapter(){return this.waitFor("_adapter")}setTimeProvider(t){this._time=t,this.notifyReady()}waitForTimeProvider(){return this.waitFor("_time")}setUpdate(t){this._update=t,this.notifyReady()}async updateParams(t="none"){if(this._adapter)for(let e in this._params){let r=this._params[e],s=await this._adapter.updateParam(e,r);if(!s)continue;let{value:i,update:n}=s;if(n)for(let m in n)this.setParamValue(e,n[m],m,"none");this.setParamValue(e,i,void 0,i!=null||n?t:"none")}}setParamValue(t,e,r,s="all"){let{spec:i,impl:n}=this.ensureParam(t);if(e!=null){let m=i;if(r){let{spec:p,impl:d}=this.ensureNestedParam(i,r);m=p,n=d}if(!n.validate(m,e)){this.paramError(t);return}i[r||"value"]=n.coerce?n.coerce(m,e):e,r||(i.state="custom")}this.emit({type:"genart:param-change",__self:!0,param:this.asNestedParam(i),paramID:t,key:r},s)}randomizeParamValue(t,e,r=Math.random,s="all"){let{spec:i,impl:{randomize:n}}=this.ensureParam(t),m=n&&i.randomize!==!1;if(e){let{spec:p,impl:d}=this.ensureNestedParam(i,e),o=d.randomize&&p.randomize!==!1;o&&this.setParamValue(t,d.randomize(p,r),e,o||!m?s:"none")}m&&this.setParamValue(t,n(i,r),void 0,s)}getParamValue(t,e=0,r){let{spec:s,impl:{randomize:i,read:n}}=this.ensureParam(t);return r&&i?i(s,r):n?n(s,e):s.value??s.default}paramError(t){this.emit({type:"genart:param-error",paramID:t})}configure(t){Object.assign(this._opts,t),this.notifyInfo()}on(t,e){window.addEventListener("message",r=>{this.isRecipient(r)&&r.data?.type===t&&e(r.data)})}emit(t,e="all"){if(e==="none")return;t.apiID=this.id;let r=e==="all";(r||e==="self")&&window.postMessage(t,"*"),(r&&parent!==window||e==="parent")&&parent.postMessage(t,"*")}start(t=!1){let e=this._state;if(e=="play")return;if(e!=="ready"&&e!=="stop")throw new Error(`can't start in state: ${e}`);this.setState("play");let r={type:"genart:frame",__self:!0,apiID:this.id,time:0,frame:0},s=(i,n)=>{this._state=="play"&&(this._update.call(null,i,n)?this._time.next(s):this.stop(),this._opts.notifyFrameUpdate&&(r.time=i,r.frame=n,this.emit(r)))};t||this._time.start(),this._time.next(s),this.emit({type:`genart:${t?"resume":"start"}`,__self:!0})}stop(){this._state==="play"&&(this.setState("stop"),this.emit({type:"genart:stop",__self:!0}))}capture(t){this._adapter?.capture(t),this.emit({type:"genart:capture",__self:!0},"parent")}setState(t,e){this._state=t,this.emit({type:"genart:state-change",__self:!0,state:t,info:e})}ensureParam(t){Q(t);let e=A(A(this._params,"no params defined")[t],`unknown param: ${t}`);return{spec:e,impl:this.ensureParamImpl(e.type)}}ensureParamImpl(t){return Z(t),A(this._paramTypes[t],`unknown param type: ${t}`)}ensureNestedParam(t,e){let r=A(this.ensureParamImpl(t.type).params?.[e],`param type '${t.type}' has no nested: ${e}`);return{spec:r,impl:this.ensureParamImpl(r.type)}}waitFor(t){return this[t]?Promise.resolve():new Promise(e=>{let r=()=>{this[t]?e():setTimeout(r,0)};r()})}notifySetParams(){this._params&&Object.keys(this._params).length&&this.emit({type:"genart:params",__self:!0,params:this.asNestedParams({},this._params)})}notifyReady(){this._state==="init"&&this._adapter&&this._time&&this._update&&this.setState("ready")}notifyInfo(){let[t,e]=this._time.now();this.emit({type:"genart:info",opts:this._opts,state:this._state,version:this.version,seed:this.random.seed,time:t,frame:e})}isRecipient({data:t}){return t!=null&&typeof t=="object"&&(t.apiID===this.id||t.apiID==="*")}asNestedParams(t,e){for(let r in e)t[r]=this.asNestedParam(e[r]);return t}asNestedParam(t){let e={...t},r=this._paramTypes[t.type];return r.params&&(e.__params=this.asNestedParams({},r.params)),e}},Q=(a,t="ID")=>A(!(a==="__proto__"||a==="prototype"||a==="constructor"),`illegal param ${t}: ${a}`),Z=a=>Q(a,"type");globalThis.$genart=new J;})();
