"use strict";(()=>{var E=Object.defineProperty;var _=(r,t)=>{for(var e in t)E(r,e,{get:t[e],enumerable:!0})};var u={};_(u,{clamp:()=>$,clamp01:()=>R,div:()=>c,easeInOut5:()=>w,fit:()=>y,mix:()=>B,norm:()=>I,parseNum:()=>k,round:()=>V,smoothstep:()=>U,smoothstep01:()=>h});var k=(r,t=0)=>{let e=r?parseFloat(r):Number.NaN;return isNaN(e)?t:e},B=(r,t,e)=>r+(t-r)*e,y=(r,t,e,a,s)=>a+(s-a)*I(r,t,e),$=(r,t,e)=>r<t?t:r>e?e:r,R=r=>r<0?0:r>1?1:r,V=(r,t)=>Math.round(c(r,t))*t,I=(r,t,e)=>c(r-t,e-t),c=(r,t)=>t!=0?r/t:0,U=(r,t,e)=>h(R(c(e-r,t-r))),h=r=>r*r*(3-2*r),G=r=>{let t=2**(r-1);return e=>e<.5?t*e**r:1-(-2*e+2)**r/2},w=G(5);var T={};_(T,{choice:()=>W,color:()=>K,date:()=>L,datetime:()=>j,image:()=>X,ramp:()=>Y,range:()=>H,text:()=>q,time:()=>O,toggle:()=>v,weighted:()=>Z,xy:()=>J});var W=r=>({type:"choice",...r}),K=r=>({type:"color",...r}),j=r=>({type:"datetime",randomize:!1,...r}),L=r=>({type:"date",randomize:!1,...r}),O=r=>({type:"time",...r}),X=r=>({type:"img",randomize:!1,default:r.default||new Uint8Array(r.width*r.height),...r}),Y=r=>({type:"ramp",randomize:!1,default:0,mode:"linear",stops:[[0,0],[1,1]],...r}),H=r=>({type:"range",min:0,max:100,step:1,...r}),q=r=>({type:"text",randomize:!1,...r}),v=r=>({type:"toggle",...r}),Z=r=>({...r,type:"weighted",options:r.options.sort((t,e)=>e[0]-t[0]),total:r.options.reduce((t,e)=>t+e[0],0)}),J=r=>({type:"xy",...r});var M=(r=0,t=0)=>{let e=performance.now(),a=t,s=r;return{start(){e=performance.now(),a=t},next(i){requestAnimationFrame(i)},now(){return[s,a]},tick(){return[s=r+performance.now()-e,++a]}}};var g={};_(g,{isNumber:()=>S,isNumericArray:()=>ee,isString:()=>Q,isTypedArray:()=>F,u16:()=>l,u24:()=>b,u32:()=>te,u8:()=>P});var S=r=>typeof r=="number"&&!isNaN(r),Q=r=>typeof r=="string",ee=r=>F(r)||Array.isArray(r)&&r.every(S),F=r=>!!r&&(r instanceof Float32Array||r instanceof Float64Array||r instanceof Uint32Array||r instanceof Int32Array||r instanceof Uint8Array||r instanceof Int8Array||r instanceof Uint16Array||r instanceof Int16Array||r instanceof Uint8ClampedArray),P=r=>(r&=255,(r<16?"0":"")+r.toString(16)),l=r=>P(r>>>8)+P(r),b=r=>l(r>>>8)+P(r&255),te=r=>l(r>>>16)+l(r);var{isNumber:d,isString:m,isNumericArray:f}=g,{clamp:N,clamp01:C,mix:x,norm:z,round:D,parseNum:ae}=u,A=class{id=Math.floor(Math.random()*1e12).toString(36);_adapter;_time=M();_prng;_update;_state="init";_features;_params;_paramTypes={choice:{valid:(t,e,a)=>!!t.options.find(s=>(Array.isArray(s)?s[0]:s)===a),randomize:(t,e)=>{let a=t.options,s=a[e()*a.length|0];return Array.isArray(s)?s[0]:s}},color:{valid:(t,e,a)=>m(a)&&/^#?[0-9a-f]{6}$/.test(a),coerce:(t,e)=>e[0]!=="#"?"#"+e:e,randomize:(t,e)=>"#"+b(e()*16777216|0)},date:{valid:(t,e,a)=>a instanceof Date||d(a)||m(a)&&/^\d{4}-\d{2}-\d{2}$/.test(a),coerce:(t,e)=>d(e)?new Date(e):m(e)?new Date(Date.parse(e)):e},datetime:{valid:(t,e,a)=>a instanceof Date||d(a)||m(a)&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[-+]\d{2}:\d{2})$/.test(a),coerce:(t,e)=>d(e)?new Date(e):m(e)?new Date(Date.parse(e)):e},img:{valid:(t,e,a)=>{let{width:s,height:i}=t;return f(a)&&a.length==s*i}},ramp:{valid:(t,e,a)=>e==="mode"?["linear","smooth","exp"].includes(a):Array.isArray(a)&&a.every(f),update:(t,e,a)=>{e==="mode"?t.mode=a:t.stops=a},read:(t,e)=>{let{stops:a,mode:s}=t,i=a.length,n=i;for(;n-- >0&&!(e>=a[n][0]););i--;let o=a[n],p=a[n+1];return n<0?a[0][1]:n>=i?a[i][1]:{exp:()=>x(o[1],p[1],w(z(e,o[0],p[0]))),linear:()=>y(e,o[0],p[0],o[1],p[1]),smooth:()=>x(o[1],p[1],h(z(e,o[0],p[0])))}[s||"linear"]()}},range:{valid:(t,e,a)=>{let{min:s,max:i}=t;return d(a)&&a>=s&&a<=i},coerce:(t,e)=>{let a=t;return N(D(e??a.default,a.step||1),a.min,a.max)},randomize:(t,e)=>{let{min:a,max:s,step:i}=t;return N(D(x(a,s,e()),i||1),a,s)}},text:{valid:(t,e,a)=>{if(!m(a))return!1;let{min:s,max:i,match:n}=t;return n&&!(m(n)?new RegExp(n):n).test(a)?!1:(!s||a.length>=s)&&(!i||a.length<=i)}},time:{valid:(t,e,a)=>f(a)||m(a)&&/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(a),coerce:(t,e)=>m(e)?e.split(":").map(ae):e,randomize:(t,e)=>[e()*24|0,e()*60|0,e()*24|0]},toggle:{valid:(t,e,a)=>m(a)?/^(true|false|0|1)$/.test(a):d(a)||typeof a=="boolean",coerce:(t,e)=>e==="true"||e==="1"?!0:e==="false"||e==="0"?!1:!!e,randomize:(t,e)=>e()<.5},weighted:{valid:(t,e,a)=>!!t.options.find(s=>s[1]===a),randomize:(t,e)=>{let{options:a,total:s,default:i}=t,n=e()*s;for(let o=0,p=a.length;o<p;o++)if(s-=a[o][0],s<=n)return a[o][1];return i}},xy:{valid:(t,e,a)=>f(a)&&a.length==2,coerce:(t,e)=>[C(e[0]),C(e[1])],randomize:(t,e)=>[e(),e()]}};math=u;params=T;utils=g;constructor(){window.addEventListener("message",t=>{let e=t.data;if(!(!this.isRecipient(t)||e?.__self))switch(e.type){case"genart:start":this.start();break;case"genart:resume":this.start(!0);break;case"genart:stop":this.stop();break;case"genart:setparamvalue":this.setParamValue(e.paramID,e.value,e.key);break;case"genart:randomizeparam":this.randomizeParamValue(e.paramID)}})}get mode(){return this._adapter?.mode||"play"}get screen(){return this._adapter?.screen||{width:window.innerWidth,height:window.innerHeight,dpr:window.devicePixelRatio}}get random(){return this._prng?this._prng:this._prng=this.ensureAdapter().prng}get state(){return this._state}get paramSpecs(){return this._params}get adapter(){return this._adapter}get time(){return this._time}registerParamType(t,e){this._paramTypes[t]&&console.warn("overriding impl for param type:",t),this._paramTypes[t]=e}async setParams(t){for(let e in t){let a=t[e];if(a.default==null){let s=this.ensureParamImpl(a.type);if(s.randomize)a.default=s.randomize(a,this.random.rnd);else throw new Error(`missing default value for param: ${e}`)}}return this._params=t,this._adapter&&(await this._adapter.setParams?.(t),await this.updateParams()),this.notifySetParams(),(e,a,s)=>this.getParamValue(e,a,s)}setFeatures(t){this._features=t,this.emit({type:"genart:setfeatures",features:t})}async setAdapter(t){console.log("set adapter",t),this._adapter=t,this._params&&(await this._adapter.setParams?.(this._params),await this.updateParams(),this.notifySetParams()),this.notifyReady()}waitForAdapter(){return this.waitFor("_adapter")}setTimeProvider(t){this._time=t,this.notifyReady()}waitForTimeProvider(){return this.waitFor("_time")}setUpdate(t){this._update=t,this.notifyReady()}async updateParams(t="none"){if(this._adapter)for(let e in this._params){let a=this._params[e],s=await this._adapter.updateParam(e,a);if(!s)continue;let{value:i,update:n}=s;this.setParamValue(e,i,void 0,i!=null||n?t:"none")}}setParamValue(t,e,a,s="all"){let{spec:i,impl:n}=this.ensureParam(t);if(e!=null){if(!n.valid(i,a,e)){this.paramError(t);return}n.update?n.update(i,a,e):i.value=n.coerce?n.coerce(i,e):e}this.emit({type:"genart:paramchange",paramID:t,spec:i,__self:!0},s)}randomizeParamValue(t,e=Math.random,a="all"){let{spec:s,impl:i}=this.ensureParam(t);i.randomize&&this.setParamValue(t,i.randomize(s,e),void 0,a)}getParamValue(t,e=0,a){let{spec:s,impl:{randomize:i,read:n}}=this.ensureParam(t);return a&&i?i(s,a):n?n(s,e):s.value??s.default}paramError(t){this.emit({type:"genart:paramerror",paramID:t})}on(t,e){window.addEventListener("message",a=>{this.isRecipient(a)&&a.data?.type===t&&e(a.data)})}emit(t,e="all"){e!=="none"&&(t.apiID=this.id,(e==="all"||e==="self")&&window.postMessage(t,"*"),(e==="all"&&parent!==window||e==="parent")&&parent.postMessage(t,"*"))}start(t=!1){if(this._state=="play")return;if(this._state!=="ready"&&this._state!=="stop")throw new Error(`can't start in state: ${this._state}`);this.setState("play");let e=!t,a=()=>{this._state=="play"&&(this._update.call(null,...this._time[e?"now":"tick"]())?this._time.next(a):this.stop(),e=!1)};t||this._time.start(),a(),this.emit({type:`genart:${t?"resume":"start"}`,__self:!0})}stop(){this._state==="play"&&(this.setState("stop"),this.emit({type:"genart:stop",__self:!0}))}capture(t){this._adapter?.capture(t),this.emit({type:"genart:capture",__self:!0},"parent")}setState(t){this._state=t,this.emit({type:"genart:statechange",state:t,__self:!0})}ensureAdapter(){if(!this._adapter)throw new Error("missing platform adapter");return this._adapter}ensureTimeProvider(){if(!this._time)throw new Error("missing time provider");return this._time}ensureParams(){if(!this._params)throw new Error("no params defined");return this._params}ensureParam(t){let e=this.ensureParams()[t];if(!e)throw new Error(`unknown param: ${t}`);let a=this.ensureParamImpl(e.type);return{spec:e,impl:a}}ensureParamImpl(t){let e=this._paramTypes[t];if(!e)throw new Error(`unknown param type: ${t}`);return e}waitFor(t){return this[t]?Promise.resolve():new Promise(e=>{let a=()=>{this[t]?e():setTimeout(a,0)};a()})}notifySetParams(){this._params&&Object.keys(this._params).length&&this.emit({type:"genart:setparams",params:this._params,__self:!0})}notifyReady(){this._state==="init"&&this._adapter&&this._time&&this._update&&this.setState("ready")}isRecipient({data:t}){return t!=null&&typeof t=="object"&&(!this.id||this.id===t.apiID)}};globalThis.$genart=new A;})();
