"use strict";(()=>{var Nt=Object.defineProperty;var N=(e,t)=>{for(var r in t)Nt(e,r,{get:t[r],enumerable:!0})};var G={};N(G,{clamp:()=>I,clamp01:()=>w,div:()=>L,easeInOut5:()=>$,fit:()=>k,mix:()=>T,norm:()=>M,parseNum:()=>O,round:()=>_,smoothstep:()=>Lt,smoothstep01:()=>B});var O=(e,t=0)=>{let r=e?parseFloat(e):Number.NaN;return isNaN(r)?t:r},T=(e,t,r)=>e+(t-e)*r,k=(e,t,r,a,n)=>a+(n-a)*M(e,t,r),I=(e,t,r)=>e<t?t:e>r?r:e,w=e=>e<0?0:e>1?1:e,_=(e,t)=>Math.round(L(e,t))*t,M=(e,t,r)=>L(e-t,r-t),L=(e,t)=>t!=0?e/t:0,Lt=(e,t,r)=>B(w(L(r-e,t-e))),B=e=>e*e*(3-2*e),Bt=e=>{let t=2**(e-1);return r=>r<.5?t*r**e:1-(-2*r+2)**e/2},$=Bt(5);var Q={};N(Q,{PARAM_DEFAULTS:()=>ft,bigint:()=>Ut,binary:()=>Ct,choice:()=>Z,color:()=>Ot,date:()=>kt,datetime:()=>$t,image:()=>Gt,numlist:()=>J,ramp:()=>Kt,range:()=>Wt,strlist:()=>Xt,text:()=>qt,time:()=>Ht,toggle:()=>Yt,vector:()=>Zt,weighted:()=>Jt,xy:()=>Qt});var E={};N(E,{ensure:()=>y,equiv:()=>Y,equivArrayLike:()=>dt,equivObject:()=>pt,formatValuePrec:()=>jt,hashBytes:()=>lt,hashString:()=>Vt,isBigInt:()=>X,isFunction:()=>W,isInRange:()=>g,isNumber:()=>f,isNumericArray:()=>h,isPrim:()=>K,isString:()=>p,isStringArray:()=>q,isTypedArray:()=>z,parseBigInt:()=>V,parseBigInt128:()=>mt,parseUUID:()=>zt,stringifyBigInt:()=>vt,u16:()=>j,u24:()=>H,u32:()=>Ft,u8:()=>v,valuePrec:()=>ot});var F=0xfffffffffn,A=Math.imul,st=Object.getPrototypeOf({}),y=(e,t)=>{if(!e)throw new Error(t);return e},X=e=>typeof e=="bigint",f=e=>typeof e=="number"&&!isNaN(e),p=e=>typeof e=="string",K=e=>{let t=typeof e;return t==="bigint"||t==="boolean"||t==="number"||t==="string"||t==="symbol"},W=e=>typeof e=="function",h=e=>z(e)||Array.isArray(e)&&e.every(f),q=e=>Array.isArray(e)&&e.every(p),z=e=>!!e&&(e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint32Array||e instanceof Int32Array||e instanceof Uint8Array||e instanceof Int8Array||e instanceof Uint16Array||e instanceof Int16Array||e instanceof Uint8ClampedArray),g=(e,t,r)=>e>=t&&e<=r,v=e=>(e&=255,(e<16?"0":"")+e.toString(16)),j=e=>v(e>>>8)+v(e),H=e=>j(e>>>8)+v(e&255),Ft=e=>j(e>>>16)+j(e),vt=(e,t=10)=>{let r={10:"",2:"0b",8:"0o",16:"0x"}[t];return e<0n?"-"+r+(-e).toString(t):r+e.toString(t)},V=e=>/^-0[box]/.test(e)?-BigInt(e.substring(1)):BigInt(e),mt=e=>new Uint32Array([Number(e>>96n&F),Number(e>>64n&F),Number(e>>32n&F),Number(e&F)]),ot=e=>{let t=e.toString(),r=t.indexOf(".");return r>0?t.length-r-1:0},jt=e=>{let t=ot(e);return r=>r.toFixed(t)},Y=(e,t)=>{let r;return e===t?!0:e==null?t==null:t==null?e==null:K(e)||K(t)||W(e)||W(t)?e===t||e!==e&&t!==t:e.length!=null&&t.length!=null?dt(e,t):(r=Object.getPrototypeOf(e),(r==null||r===st)&&(r=Object.getPrototypeOf(t),r==null||r===st)?pt(e,t):e instanceof Date&&t instanceof Date?e.getTime()===t.getTime():e instanceof RegExp&&t instanceof RegExp?e.toString()===t.toString():e===t)},pt=(e,t)=>{if(Object.keys(e).length!==Object.keys(t).length)return!1;for(let r in e)if(!(t.hasOwnProperty(r)&&Y(e[r],t[r])))return!1;return!0},dt=(e,t)=>{if(e.length!==t.length)return!1;let r=e.length;for(;r-- >0&&Y(e[r],t[r]););return r<0},zt=e=>mt(BigInt("0x"+e.replace(/-/g,"").substring(0,32))),lt=(e,t=0)=>{let r=s=>e[s+3]<<24|e[s+2]<<16|e[s+1]<<8|e[s],a=(s,d)=>s<<d|s>>>32-d,n=(s,d)=>{let P=d+1&3;x[d]=A(a(x[d]^A(a(A(r(s),u[d]),15+d),u[P]),19-(d<<1))+x[P],5)+c[d]},i=s=>{let d=s[0]+=s[1]+s[2]+s[3];return s[1]+=d,s[2]+=d,s[3]+=d,s},m=s=>(s^=s>>>16,s=A(s,2246822507),s^=s>>>13,s=A(s,3266489909),s^=s>>>16),o=e.length,c=new Uint32Array([1444728091,197830471,2530024501,850148119]),u=new Uint32Array([597399067,2869860233,951274213,2716044179]),x=u.map(s=>s^t),b=0;for(let s=o&-16;b<s;b+=16)n(b,0),n(b+4,1),n(b+8,2),n(b+12,3);c.fill(0);for(let s=o&15;s>0;s--){let d=s-1;if((s&3)===1){let P=s>>2;c[P]=a(A(c[P]^e[b+d],u[P]),15+P),x[P]^=A(c[P],u[P+1&3])}else c[d>>2]^=e[b+d]<<(d<<3)}return i(i(x.map(s=>s^o)).map(m))},Vt=(e,t)=>lt(new TextEncoder().encode(e),t);var Et=/^\d{4}-\d{2}-\d{2}$/,D={validate:(e,t)=>t instanceof Date||f(t)||p(t)&&Et.test(t),coerce:(e,t)=>f(t)?new Date(t):p(t)?new Date(Date.parse(t)):t};var Dt=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[-+]\d{2}:\d{2})$/,U={validate:(e,t)=>t instanceof Date||f(t)||p(t)&&Dt.test(t),coerce:(e,t)=>f(t)?new Date(t):p(t)?new Date(Date.parse(t)):t};var S={validate:(e,t)=>h(t)&&t.length===3&&g(t[0],0,23)&&g(t[1],0,59)&&g(t[2],0,59)||p(t)&&/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(t),coerce:(e,t)=>p(t)?t.split(":").map(O):t,randomize:(e,t)=>[t()*24|0,t()*60|0,t()*60|0]};var C={validate:(e,t)=>{let{min:r,max:a,size:n}=e;return h(t)&&t.length===n&&t.every((i,m)=>g(i,r[m],a[m]))},coerce:(e,t)=>{let{min:r,max:a,step:n}=e;return t.map((i,m)=>I(_(i,n[m]),r[m],a[m]))},randomize:(e,t)=>{let{min:r,max:a,size:n,step:i}=e;return new Array(n).fill(0).map((m,o)=>I(_(T(r[o],a[o],t()),i[o]),r[o],a[o]))}};var ft={desc:"TODO description",edit:"protected",group:"main",order:0,randomize:!0,state:"void",update:"event",widget:"default"},l=(e,t,r=!0)=>(y(t.name,"missing param `name`"),{...ft,type:e,randomize:r,...t}),ct=(e,t)=>t!=null?y(e.validate(null,t),`invalid default value: ${t}`)&&e.coerce(null,t):t,gt=(e,t=10)=>{let r=0,a=e.maxLength||t;return e.minLength&&(r=e.minLength,e.maxLength||(a=Math.max(r,t))),y(r<=a,"invalid list length constraint"),[r,a]},Ut=e=>l("bigint",{min:0n,max:0xffffffffffffffffn,...e}),Ct=e=>l("binary",{minLength:0,maxLength:1024,...e},!1),Z=e=>l("choice",e),Ot=e=>l("color",e),kt=e=>l("date",{...e,default:ct(D,e.default)},!1),$t=e=>l("datetime",{...e,default:ct(U,e.default)},!1),Gt=e=>l("img",{default:e.default||new(e.format==="gray"?Uint8Array:Uint32Array)(e.width*e.height),...e},!1),J=e=>{let[t,r]=gt(e,10);return l("numlist",{default:e.default||new Array(t).fill(0),minLength:t,maxLength:r,...e},!1)},Kt=e=>l("ramp",{...e,stops:e.stops?e.stops.flat():[0,0,1,1],mode:e.mode||"linear",default:0},!1),Wt=e=>l("range",{min:0,max:100,step:1,...e}),Xt=e=>{let[t,r]=gt(e,10);return l("strlist",{default:e.default||new Array(t).fill(""),minLength:t,maxLength:r,...e},!1)},qt=e=>l("text",{minLength:0,maxLength:32,multiline:!1,...e},!1),Ht=e=>l("time",{...e,default:e.default!=null?y(S.validate(null,e.default),"")&&S.coerce(null,e.default):e.default}),Yt=e=>l("toggle",e),Zt=e=>{e.labels?y(e.labels.length>=e.size,`expected ${e.size} labels`):y(e.size<=4,"missing vector labels");let t=(a,n,i=0)=>Array.isArray(n)?(y(n.length===a,"wrong vector size"),n):new Array(a).fill(f(n)?n:i),r={min:t(e.size,e.min,0),max:t(e.size,e.max,1),step:t(e.size,e.step,.01)};return l("vector",{...e,...r,default:e.default?y(e.default.length==e.size,`wrong vector size, expected ${e.size} values`)&&C.coerce(r,e.default):e.default,labels:e.labels||["X","Y","Z","W"].slice(0,e.size)})},Jt=e=>l("weighted",{...e,options:e.options.sort((t,r)=>r[0]-t[0]),total:e.options.reduce((t,r)=>t+r[0],0)}),Qt=e=>l("xy",e);var et={};N(et,{defPRNG:()=>ee,randomBigInt:()=>tt,sfc32:()=>te});var te=e=>{let t=new Uint32Array(4);return t.set(e),()=>{let r=(t[0]+t[1]>>>0)+t[3]>>>0;return t[3]=t[3]+1>>>0,t[0]=t[1]^t[1]>>>9,t[1]=t[2]+(t[2]<<3)>>>0,t[2]=(t[2]<<21|t[2]>>>11)+r>>>0,r/4294967296}},tt=(e,t=Math.random)=>{let r=0n;for(let a=Math.log2(Number(e))+31>>5;a-- >0;)r=r<<32n|BigInt(t()*4294967296>>>0);return r%e},ee=(e,t,r)=>{let a=()=>r(t);return{seed:e,reset:a,rnd:a()}};var ut={validate:(e,t)=>{let{min:r,max:a}=e;if(p(t)){if(!/^-?([0-9]+|0x[0-9a-f]+|0b[01]+|0o[0-7]+)$/.test(t))return!1;t=V(t)}else if(f(t)||X(t))t=BigInt(t);else return!1;return t>=r&&t<=a},coerce:(e,t)=>p(t)?V(t):BigInt(t),randomize:(e,t)=>{let{min:r,max:a}=e;return r+tt(a-r,t)}};var Pt={validate:(e,t)=>{let{minLength:r,maxLength:a}=e;return t instanceof Uint8Array&&t.length>=r&&t.length<=a}};var yt={validate:(e,t)=>!!e.options.find(r=>(p(r)?r:r[0])===t),randomize:(e,t)=>{let r=e.options,a=r[t()*r.length|0];return p(a)?a:a[0]}};var ht={validate:(e,t)=>p(t)&&/^#?[0-9a-f]{6,8}$/i.test(t),coerce:(e,t)=>(t[0]!=="#"?"#"+t:t).substring(0,7),randomize:(e,t)=>"#"+H(t()*16777216|0)};var xt={validate:(e,t)=>{let{width:r,height:a,format:n}=e;return z(t)&&t.length==r*a&&(n==="gray"?t instanceof Uint8Array||t instanceof Uint8ClampedArray:t instanceof Uint32Array)}};var bt={validate:(e,t)=>{let{minLength:r,maxLength:a}=e;return h(t)&&g(t.length,r,a)}};var Tt={validate:(e,t)=>f(t),read:(e,t)=>{let{stops:r,mode:a}=e,n=r.length,i=n;for(;(i-=2)>=0&&!(t>=r[i]););n-=2;let m=r[i],o=r[i+1],c=r[i+2],u=r[i+3];return i<0?r[1]:i>=n?r[n+1]:{exp:()=>T(o,u,$(M(t,m,c))),linear:()=>k(t,m,c,o,u),smooth:()=>T(o,u,B(M(t,m,c)))}[a||"linear"]()},params:{stops:J({name:"Ramp stops",desc:"Control points",minLength:4,maxLength:1/0,default:[]}),mode:Z({name:"Ramp mode",desc:"Interpolation method",options:["linear","smooth","exp"]})}};var It={validate:(e,t)=>{let{min:r,max:a}=e;return f(t)&&g(t,r,a)},coerce:(e,t)=>{let r=e;return I(_(t??r.default,r.step||1),r.min,r.max)},randomize:(e,t)=>{let{min:r,max:a,step:n}=e;return I(_(T(r,a,t()),n||1),r,a)}};var _t={validate:(e,t)=>{let{minLength:r,maxLength:a,match:n}=e;if(!(q(t)&&g(t.length,r,a)))return!1;if(n){let i=p(n)?new RegExp(n):n;return t.every(m=>i.test(m))}return!0}};var At={validate:(e,t)=>{if(!p(t))return!1;let{minLength:r,maxLength:a,match:n}=e;return n&&!(p(n)?new RegExp(n):n).test(t)?!1:g(t.length,r,a)}};var Rt={validate:(e,t)=>p(t)?/^(true|false|0|1)$/.test(t):t===1||t===0||typeof t=="boolean",coerce:(e,t)=>t==="true"||t==="1"?!0:t==="false"||t==="0"?!1:!!t,randomize:(e,t)=>t()<.5};var wt={validate:(e,t)=>!!e.options.find(r=>r[1]===t),randomize:(e,t)=>{let{options:r,total:a,default:n}=e,i=t()*a;for(let m=0,o=r.length;m<o;m++)if(a-=r[m][0],a<=i)return r[m][1];return n}};var Mt={validate:(e,t)=>h(t)&&t.length==2,coerce:(e,t)=>[w(t[0]),w(t[1])],randomize:(e,t)=>[t(),t()]};var St=(e=250,t=60,r=0)=>{let a=r,n=1e3/t;return{start(){a=r-1},next(i){setTimeout(()=>{a++,i(a*n,a)},e)},now:()=>[a*n,a]}};var rt=(e=0,t=0)=>{let r=performance.now(),a=t,n=e,i=!0;return{start(){i=!0},next(m){requestAnimationFrame(o=>{i?(r=o,a=t,i=!1):a++,n=e+o-r,m(n,a)})},now:()=>[n,a]}};var{ensure:R,isFunction:re}=E,nt=class{_opts={id:Math.floor(Math.random()*1e12).toString(36),allowExternalConfig:!1,notifyFrameUpdate:!1};_adapter;_time=rt();_prng;_update;_state="init";_traits;_params;_paramTypes={bigint:ut,binary:Pt,choice:yt,color:ht,date:D,datetime:U,image:xt,numlist:bt,ramp:Tt,range:It,strlist:_t,text:At,time:S,toggle:Rt,vector:C,weighted:wt,xy:Mt};math=G;params=Q;prng=et;utils=E;time={offline:St,raf:rt};constructor(){window.addEventListener("message",t=>{let r=t.data;if(!(!this.isRecipient(t)||r?.__self))switch(r.type){case"genart:get-info":this.notifyInfo();break;case"genart:randomize-param":this.randomizeParamValue(r.paramID,r.key);break;case"genart:resume":this.start(!0);break;case"genart:configure":{let a=r.opts;delete a.id,delete a.allowExternalConfig,this.configure(a);break}case"genart:set-param-value":this.setParamValue(r.paramID,r.value,r.key);break;case"genart:start":this.start();break;case"genart:stop":this.stop();break}})}get version(){return"0.23.0"}get id(){return this._opts.id}get mode(){return this._adapter?.mode||"play"}get screen(){return this._adapter?.screen||{width:window.innerWidth,height:window.innerHeight,dpr:window.devicePixelRatio}}get random(){return this._prng?this._prng:this._prng=R(this._adapter,"missing platform adapter").prng}get state(){return this._state}get paramSpecs(){return this._params}get adapter(){return this._adapter}get timeProvider(){return this._time}registerParamType(t,r){at(t),this._paramTypes[t]&&console.warn("overriding impl for param type:",t),this._paramTypes[t]=r}paramType(t){return at(t),this._paramTypes[t]}async setParams(t){try{this._adapter?.augmentParams&&(t=this._adapter.augmentParams(t)),this._params={};for(let r in t){it(r);let a={...t.PARAM_DEFAULTS,...t[r]},n=this.ensureParamImpl(a.type);if(a.default==null)if(n.randomize)a.default=n.randomize(a,this.random.rnd),a.state="random";else if(n.read)a.state="dynamic";else throw new Error(`missing default value for param: ${r}`);else{if(!n.validate(a,a.default))throw new Error(`invalid default value for param: ${r} (${a.default})`);a.state="default"}this._params[r]=a}return this._adapter&&(this._adapter.initParams&&await this._adapter.initParams(this._params),await this.updateParams()),this.notifySetParams(),this.getParamValue.bind(this)}catch(r){throw this.setState("error",r.message),r}}setTraits(t){this._traits=t,this.emit({type:"genart:traits",traits:t})}async setAdapter(t){this._adapter=t,this.notifyReady()}waitForAdapter(){return this.waitFor("_adapter")}setTimeProvider(t){this._time=t,this.notifyReady()}waitForTimeProvider(){return this.waitFor("_time")}setUpdate(t){this._update=t,this.notifyReady()}async updateParams(t="none"){if(this._adapter)for(let r in this._params){let a=this._params[r],n=await this._adapter.updateParam(r,a);if(!n)continue;let{value:i,update:m}=n;if(m)for(let o in m)this.setParamValue(r,m[o],o,"none");this.setParamValue(r,i,void 0,i!=null||m?t:"none")}}setParamValue(t,r,a,n="all"){let{spec:i,impl:m}=this.ensureParam(t);if(r!=null){let o=i;if(a){let{spec:c,impl:u}=this.ensureNestedParam(i,a);o=c,m=u}if(!m.validate(o,r)){this.paramError(t);return}i[a||"value"]=m.coerce?m.coerce(o,r):r,a||(i.state="custom")}this.emit({type:"genart:param-change",__self:!0,param:this.asNestedParam(i),paramID:t,key:a},n)}randomizeParamValue(t,r,a=Math.random,n="all"){let{spec:i,impl:{randomize:m}}=this.ensureParam(t),o=m&&i.randomize!==!1;if(r){let{spec:c,impl:u}=this.ensureNestedParam(i,r),x=u.randomize&&c.randomize!==!1;x&&this.setParamValue(t,u.randomize(c,a),r,x||!o?n:"none")}o&&this.setParamValue(t,m(i,a),void 0,n)}getParamValue(t,r){return this.paramValueGetter(t)(r)}paramValueGetter(t){let{spec:r,impl:{randomize:a,read:n}}=this.ensureParam(t);return(i=0)=>{if(re(i)){if(a)return a(r,i);i=0}return n?n(r,i):r.value??r.default}}paramError(t){this.emit({type:"genart:param-error",paramID:t})}configure(t){Object.assign(this._opts,t),this.notifyInfo()}on(t,r){window.addEventListener("message",a=>{this.isRecipient(a)&&a.data?.type===t&&r(a.data)})}emit(t,r="all"){if(r==="none")return;t.apiID=this.id;let a=r==="all";(a||r==="self")&&window.postMessage(t,"*"),(a&&parent!==window||r==="parent")&&parent.postMessage(t,"*")}start(t=!1){let r=this._state;if(r=="play")return;if(r!=="ready"&&r!=="stop")throw new Error(`can't start in state: ${r}`);this.setState("play");let a={type:"genart:frame",__self:!0,apiID:this.id,time:0,frame:0},n=(i,m)=>{this._state=="play"&&(this._update.call(null,i,m)?this._time.next(n):this.stop(),this._opts.notifyFrameUpdate&&(a.time=i,a.frame=m,this.emit(a)))};t||this._time.start(),this._time.next(n),this.emit({type:`genart:${t?"resume":"start"}`,__self:!0})}stop(){this._state==="play"&&(this.setState("stop"),this.emit({type:"genart:stop",__self:!0}))}capture(t){this._adapter?.capture(t),this.emit({type:"genart:capture",__self:!0},"parent")}setState(t,r){this._state=t,this.emit({type:"genart:state-change",__self:!0,state:t,info:r})}ensureParam(t){it(t);let r=R(R(this._params,"no params defined")[t],`unknown param: ${t}`);return{spec:r,impl:this.ensureParamImpl(r.type)}}ensureParamImpl(t){return at(t),R(this._paramTypes[t],`unknown param type: ${t}`)}ensureNestedParam(t,r){let a=R(this.ensureParamImpl(t.type).params?.[r],`param type '${t.type}' has no nested: ${r}`);return{spec:a,impl:this.ensureParamImpl(a.type)}}waitFor(t){return this[t]?Promise.resolve():new Promise(r=>{let a=()=>{this[t]?r():setTimeout(a,0)};a()})}notifySetParams(){this._params&&Object.keys(this._params).length&&this.emit({type:"genart:params",__self:!0,params:this.asNestedParams({},this._params)})}notifyReady(){this._state==="init"&&this._adapter&&this._time&&this._update&&this.setState("ready")}notifyInfo(){let[t,r]=this._time.now();this.emit({type:"genart:info",opts:this._opts,state:this._state,version:this.version,adapter:this._adapter?.id,seed:this.random.seed,time:t,frame:r})}isRecipient({data:t}){return t!=null&&typeof t=="object"&&(t.apiID===this.id||t.apiID==="*")}asNestedParams(t,r){for(let a in r)t[a]=this.asNestedParam(r[a]);return t}asNestedParam(t){let r={...t},a=this._paramTypes[t.type];return a.params&&(r.__params=this.asNestedParams({},a.params)),r}},it=(e,t="ID")=>R(!(e==="__proto__"||e==="prototype"||e==="constructor"),`illegal param ${t}: ${e}`),at=e=>it(e,"type");globalThis.$genart=new nt;})();
