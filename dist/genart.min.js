"use strict";(()=>{var k=Object.defineProperty;var T=(a,t)=>{for(var e in t)k(a,e,{get:t[e],enumerable:!0})};var u={};T(u,{clamp:()=>v,clamp01:()=>M,div:()=>l,easeInOut5:()=>b,fit:()=>w,mix:()=>U,norm:()=>z,parseNum:()=>L,round:()=>G,smoothstep:()=>K,smoothstep01:()=>P});var L=(a,t=0)=>{let e=a?parseFloat(a):Number.NaN;return isNaN(e)?t:e},U=(a,t,e)=>a+(t-a)*e,w=(a,t,e,r,s)=>r+(s-r)*z(a,t,e),v=(a,t,e)=>a<t?t:a>e?e:a,M=a=>a<0?0:a>1?1:a,G=(a,t)=>Math.round(l(a,t))*t,z=(a,t,e)=>l(a-t,e-t),l=(a,t)=>t!=0?a/t:0,K=(a,t,e)=>P(M(l(e-a,t-a))),P=a=>a*a*(3-2*a),W=a=>{let t=2**(a-1);return e=>e<.5?t*e**a:1-(-2*e+2)**a/2},b=W(5);var N={};T(N,{choice:()=>x,color:()=>j,date:()=>X,datetime:()=>O,image:()=>Y,numlist:()=>A,ramp:()=>H,range:()=>q,strlist:()=>Z,text:()=>J,time:()=>Q,toggle:()=>ee,weighted:()=>te,xy:()=>ae});var x=a=>({type:"choice",...a}),j=a=>({type:"color",...a}),O=a=>({type:"datetime",randomize:!1,...a}),X=a=>({type:"date",randomize:!1,...a}),Y=a=>({type:"img",randomize:!1,default:a.default||new Uint8Array(a.width*a.height),...a}),A=a=>({type:"numlist",randomize:!1,default:[],...a}),H=a=>({type:"ramp",name:a.name,desc:a.desc,doc:a.doc,stops:a.stops?a.stops.flat():[0,0,1,1],mode:a.mode||"linear",randomize:!1,default:0}),q=a=>({type:"range",min:0,max:100,step:1,...a}),Z=a=>({type:"strlist",randomize:!1,default:[],...a}),J=a=>({type:"text",randomize:!1,...a}),Q=a=>({type:"time",...a}),ee=a=>({type:"toggle",...a}),te=a=>({...a,type:"weighted",options:a.options.sort((t,e)=>e[0]-t[0]),total:a.options.reduce((t,e)=>t+e[0],0)}),ae=a=>({type:"xy",...a});var C=(a=0,t=0)=>{let e=performance.now(),r=t,s=a;return{start(){e=performance.now(),r=t},next(i){requestAnimationFrame(i)},now(){return[s,r]},tick(){return[s=a+performance.now()-e,++r]}}};var y={};T(y,{isNumber:()=>D,isNumericArray:()=>se,isString:()=>re,isTypedArray:()=>E,u16:()=>f,u24:()=>R,u32:()=>ie,u8:()=>g});var D=a=>typeof a=="number"&&!isNaN(a),re=a=>typeof a=="string",se=a=>E(a)||Array.isArray(a)&&a.every(D),E=a=>!!a&&(a instanceof Float32Array||a instanceof Float64Array||a instanceof Uint32Array||a instanceof Int32Array||a instanceof Uint8Array||a instanceof Int8Array||a instanceof Uint16Array||a instanceof Int16Array||a instanceof Uint8ClampedArray),g=a=>(a&=255,(a<16?"0":"")+a.toString(16)),f=a=>g(a>>>8)+g(a),R=a=>f(a>>>8)+g(a&255),ie=a=>f(a>>>16)+f(a);var{isNumber:h,isString:o,isNumericArray:_}=y,{clamp:F,clamp01:B,mix:I,norm:V,round:$,parseNum:ne}=u,S=class{id=Math.floor(Math.random()*1e12).toString(36);_adapter;_time=C();_prng;_update;_state="init";_traits;_params;_paramTypes={choice:{validate:(t,e)=>!!t.options.find(r=>(Array.isArray(r)?r[0]:r)===e),randomize:(t,e)=>{let r=t.options,s=r[e()*r.length|0];return Array.isArray(s)?s[0]:s}},color:{validate:(t,e)=>o(e)&&/^#?[0-9a-f]{6}$/.test(e),coerce:(t,e)=>e[0]!=="#"?"#"+e:e,randomize:(t,e)=>"#"+R(e()*16777216|0)},date:{validate:(t,e)=>e instanceof Date||h(e)||o(e)&&/^\d{4}-\d{2}-\d{2}$/.test(e),coerce:(t,e)=>h(e)?new Date(e):o(e)?new Date(Date.parse(e)):e},datetime:{validate:(t,e)=>e instanceof Date||h(e)||o(e)&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[-+]\d{2}:\d{2})$/.test(e),coerce:(t,e)=>h(e)?new Date(e):o(e)?new Date(Date.parse(e)):e},img:{validate:(t,e)=>{let{width:r,height:s}=t;return _(e)&&e.length==r*s}},numlist:{validate:(t,e)=>_(e)},ramp:{validate:()=>!1,read:(t,e)=>{let{stops:r,mode:s}=t,i=r.length,n=i;for(;(n-=2)>=0&&!(e>=r[n]););i-=2;let m=r[n],p=r[n+1],d=r[n+2],c=r[n+3];return n<0?r[1]:n>=i?r[i+1]:{exp:()=>I(p,c,b(V(e,m,d))),linear:()=>w(e,m,d,p,c),smooth:()=>I(p,c,P(V(e,m,d)))}[s||"linear"]()},params:{stops:A({name:"Ramp stops",desc:"Control points",default:[]}),mode:x({name:"Ramp mode",desc:"Interpolation method",options:["linear","smooth","exp"]})}},range:{validate:(t,e)=>{let{min:r,max:s}=t;return h(e)&&e>=r&&e<=s},coerce:(t,e)=>{let r=t;return F($(e??r.default,r.step||1),r.min,r.max)},randomize:(t,e)=>{let{min:r,max:s,step:i}=t;return F($(I(r,s,e()),i||1),r,s)}},strlist:{validate:(t,e)=>Array.isArray(e)&&e.every(o)},text:{validate:(t,e)=>{if(!o(e))return!1;let{min:r,max:s,match:i}=t;return i&&!(o(i)?new RegExp(i):i).test(e)?!1:(!r||e.length>=r)&&(!s||e.length<=s)}},time:{validate:(t,e)=>_(e)||o(e)&&/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(e),coerce:(t,e)=>o(e)?e.split(":").map(ne):e,randomize:(t,e)=>[e()*24|0,e()*60|0,e()*24|0]},toggle:{validate:(t,e)=>o(e)?/^(true|false|0|1)$/.test(e):h(e)||typeof e=="boolean",coerce:(t,e)=>e==="true"||e==="1"?!0:e==="false"||e==="0"?!1:!!e,randomize:(t,e)=>e()<.5},weighted:{validate:(t,e)=>!!t.options.find(r=>r[1]===e),randomize:(t,e)=>{let{options:r,total:s,default:i}=t,n=e()*s;for(let m=0,p=r.length;m<p;m++)if(s-=r[m][0],s<=n)return r[m][1];return i}},xy:{validate:(t,e)=>_(e)&&e.length==2,coerce:(t,e)=>[B(e[0]),B(e[1])],randomize:(t,e)=>[e(),e()]}};math=u;params=N;utils=y;constructor(){window.addEventListener("message",t=>{let e=t.data;if(!(!this.isRecipient(t)||e?.__self))switch(e.type){case"genart:start":this.start();break;case"genart:resume":this.start(!0);break;case"genart:stop":this.stop();break;case"genart:setparamvalue":this.setParamValue(e.paramID,e.value,e.key);break;case"genart:randomizeparam":this.randomizeParamValue(e.paramID,e.key)}})}get mode(){return this._adapter?.mode||"play"}get screen(){return this._adapter?.screen||{width:window.innerWidth,height:window.innerHeight,dpr:window.devicePixelRatio}}get random(){return this._prng?this._prng:this._prng=this.ensureAdapter().prng}get state(){return this._state}get paramSpecs(){return this._params}get adapter(){return this._adapter}get time(){return this._time}registerParamType(t,e){this._paramTypes[t]&&console.warn("overriding impl for param type:",t),this._paramTypes[t]=e}paramType(t){return this._paramTypes[t]}async setParams(t){for(let e in t){let r=t[e];if(r.default==null){let s=this.ensureParamImpl(r.type);if(s.randomize)r.default=s.randomize(r,this.random.rnd);else throw new Error(`missing default value for param: ${e}`)}}return this._params=t,this._adapter&&(await this._adapter.setParams?.(t),await this.updateParams()),this.notifySetParams(),(e,r,s)=>this.getParamValue(e,r,s)}setTraits(t){this._traits=t,this.emit({type:"genart:settraits",traits:t})}async setAdapter(t){console.log("set adapter",t),this._adapter=t,this._params&&(await this._adapter.setParams?.(this._params),await this.updateParams(),this.notifySetParams()),this.notifyReady()}waitForAdapter(){return this.waitFor("_adapter")}setTimeProvider(t){this._time=t,this.notifyReady()}waitForTimeProvider(){return this.waitFor("_time")}setUpdate(t){this._update=t,this.notifyReady()}async updateParams(t="none"){if(this._adapter)for(let e in this._params){let r=this._params[e],s=await this._adapter.updateParam(e,r);if(!s)continue;let{value:i,update:n}=s;if(n)for(let m in n)this.setParamValue(e,n[m],m,"none");this.setParamValue(e,i,void 0,i!=null||n?t:"none")}}setParamValue(t,e,r,s="all"){let{spec:i,impl:n}=this.ensureParam(t);if(e!=null){let m=i;if(r){let{spec:p,impl:d}=this.ensureNestedParam(i,r);m=p,n=d}if(!n.validate(m,e)){this.paramError(t);return}i[r||"value"]=n.coerce?n.coerce(m,e):e}this.notifyParamChange(t,i,s)}randomizeParamValue(t,e,r=Math.random,s="all"){let{spec:i,impl:{randomize:n}}=this.ensureParam(t),m=n&&i.randomize!==!1;if(e){let{spec:p,impl:d}=this.ensureNestedParam(i,e),c=d.randomize&&p.randomize!==!1;c&&this.setParamValue(t,d.randomize(p,r),e,c||!m?s:"none")}m&&this.setParamValue(t,n(i,r),void 0,s)}getParamValue(t,e=0,r){let{spec:s,impl:{randomize:i,read:n}}=this.ensureParam(t);return r&&i?i(s,r):n?n(s,e):s.value??s.default}paramError(t){this.emit({type:"genart:paramerror",paramID:t})}on(t,e){window.addEventListener("message",r=>{this.isRecipient(r)&&r.data?.type===t&&e(r.data)})}emit(t,e="all"){e!=="none"&&(t.apiID=this.id,(e==="all"||e==="self")&&window.postMessage(t,"*"),(e==="all"&&parent!==window||e==="parent")&&parent.postMessage(t,"*"))}start(t=!1){if(this._state=="play")return;if(this._state!=="ready"&&this._state!=="stop")throw new Error(`can't start in state: ${this._state}`);this.setState("play");let e=!t,r=()=>{this._state=="play"&&(this._update.call(null,...this._time[e?"now":"tick"]())?this._time.next(r):this.stop(),e=!1)};t||this._time.start(),r(),this.emit({type:`genart:${t?"resume":"start"}`,__self:!0})}stop(){this._state==="play"&&(this.setState("stop"),this.emit({type:"genart:stop",__self:!0}))}capture(t){this._adapter?.capture(t),this.emit({type:"genart:capture",__self:!0},"parent")}setState(t){this._state=t,this.emit({type:"genart:statechange",state:t,__self:!0})}ensureAdapter(){if(!this._adapter)throw new Error("missing platform adapter");return this._adapter}ensureTimeProvider(){if(!this._time)throw new Error("missing time provider");return this._time}ensureParams(){if(!this._params)throw new Error("no params defined");return this._params}ensureParam(t){let e=this.ensureParams()[t];if(!e)throw new Error(`unknown param: ${t}`);let r=this.ensureParamImpl(e.type);return{spec:e,impl:r}}ensureParamImpl(t){let e=this._paramTypes[t];if(!e)throw new Error(`unknown param type: ${t}`);return e}ensureNestedParam(t,e){let s=this.ensureParamImpl(t.type).params?.[e];if(!s)throw new Error(`param type '${t.type}' has no nested: ${e}`);return{spec:s,impl:this.ensureParamImpl(s.type)}}waitFor(t){return this[t]?Promise.resolve():new Promise(e=>{let r=()=>{this[t]?e():setTimeout(r,0)};r()})}notifySetParams(){this._params&&Object.keys(this._params).length&&this.emit({type:"genart:setparams",params:this.asNestedParams({},this._params),__self:!0})}notifyParamChange(t,e,r){this.emit({type:"genart:paramchange",paramID:t,spec:this.asNestedParam(e),__self:!0},r)}notifyReady(){this._state==="init"&&this._adapter&&this._time&&this._update&&this.setState("ready")}isRecipient({data:t}){return t!=null&&typeof t=="object"&&(!this.id||this.id===t.apiID)}asNestedParams(t,e){for(let r in e)t[r]=this.asNestedParam(e[r]);return t}asNestedParam(t){let e={...t},r=this._paramTypes[t.type];return r.params&&(e.__params=this.asNestedParams({},r.params)),e}};globalThis.$genart=new S;})();
